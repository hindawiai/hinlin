<शैली गुरु>
// SPDX-License-Identअगरier: GPL-2.0+
/*
 * comedi/drivers/amplc_pc236_common.c
 * Common support code क्रम "amplc_pc236" and "amplc_pci236".
 *
 * Copyright (C) 2002-2014 MEV Ltd. <https://www.mev.co.uk/>
 *
 * COMEDI - Linux Control and Measurement Device Interface
 * Copyright (C) 2000 David A. Schleef <ds@schleef.org>
 */

#समावेश <linux/module.h>
#समावेश <linux/पूर्णांकerrupt.h>

#समावेश "../comedidev.h"

#समावेश "amplc_pc236.h"
#समावेश "8255.h"

अटल व्योम pc236_पूर्णांकr_update(काष्ठा comedi_device *dev, bool enable)
अणु
	स्थिर काष्ठा pc236_board *board = dev->board_ptr;
	काष्ठा pc236_निजी *devpriv = dev->निजी;
	अचिन्हित दीर्घ flags;

	spin_lock_irqsave(&dev->spinlock, flags);
	devpriv->enable_irq = enable;
	अगर (board->पूर्णांकr_update_cb)
		board->पूर्णांकr_update_cb(dev, enable);
	spin_unlock_irqrestore(&dev->spinlock, flags);
पूर्ण

/*
 * This function is called when an पूर्णांकerrupt occurs to check whether
 * the पूर्णांकerrupt has been marked as enabled and was generated by the
 * board.  If so, the function prepares the hardware क्रम the next
 * पूर्णांकerrupt.
 * Returns false अगर the पूर्णांकerrupt should be ignored.
 */
अटल bool pc236_पूर्णांकr_check(काष्ठा comedi_device *dev)
अणु
	स्थिर काष्ठा pc236_board *board = dev->board_ptr;
	काष्ठा pc236_निजी *devpriv = dev->निजी;
	bool retval = false;
	अचिन्हित दीर्घ flags;

	spin_lock_irqsave(&dev->spinlock, flags);
	अगर (devpriv->enable_irq) अणु
		अगर (board->पूर्णांकr_chk_clr_cb)
			retval = board->पूर्णांकr_chk_clr_cb(dev);
		अन्यथा
			retval = true;
	पूर्ण
	spin_unlock_irqrestore(&dev->spinlock, flags);

	वापस retval;
पूर्ण

अटल पूर्णांक pc236_पूर्णांकr_insn(काष्ठा comedi_device *dev,
			   काष्ठा comedi_subdevice *s, काष्ठा comedi_insn *insn,
			   अचिन्हित पूर्णांक *data)
अणु
	data[1] = 0;
	वापस insn->n;
पूर्ण

अटल पूर्णांक pc236_पूर्णांकr_cmdtest(काष्ठा comedi_device *dev,
			      काष्ठा comedi_subdevice *s,
			      काष्ठा comedi_cmd *cmd)
अणु
	पूर्णांक err = 0;

	/* Step 1 : check अगर triggers are trivially valid */

	err |= comedi_check_trigger_src(&cmd->start_src, TRIG_NOW);
	err |= comedi_check_trigger_src(&cmd->scan_begin_src, TRIG_EXT);
	err |= comedi_check_trigger_src(&cmd->convert_src, TRIG_FOLLOW);
	err |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);
	err |= comedi_check_trigger_src(&cmd->stop_src, TRIG_NONE);

	अगर (err)
		वापस 1;

	/* Step 2a : make sure trigger sources are unique */
	/* Step 2b : and mutually compatible */

	/* Step 3: check it arguments are trivially valid */

	err |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);
	err |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, 0);
	err |= comedi_check_trigger_arg_is(&cmd->convert_arg, 0);
	err |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,
					   cmd->chanlist_len);
	err |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);

	अगर (err)
		वापस 3;

	/* Step 4: fix up any arguments */

	/* Step 5: check channel list अगर it exists */

	वापस 0;
पूर्ण

अटल पूर्णांक pc236_पूर्णांकr_cmd(काष्ठा comedi_device *dev, काष्ठा comedi_subdevice *s)
अणु
	pc236_पूर्णांकr_update(dev, true);

	वापस 0;
पूर्ण

अटल पूर्णांक pc236_पूर्णांकr_cancel(काष्ठा comedi_device *dev,
			     काष्ठा comedi_subdevice *s)
अणु
	pc236_पूर्णांकr_update(dev, false);

	वापस 0;
पूर्ण

अटल irqवापस_t pc236_पूर्णांकerrupt(पूर्णांक irq, व्योम *d)
अणु
	काष्ठा comedi_device *dev = d;
	काष्ठा comedi_subdevice *s = dev->पढ़ो_subdev;
	bool handled;

	handled = pc236_पूर्णांकr_check(dev);
	अगर (dev->attached && handled) अणु
		अचिन्हित लघु val = 0;

		comedi_buf_ग_लिखो_samples(s, &val, 1);
		comedi_handle_events(dev, s);
	पूर्ण
	वापस IRQ_RETVAL(handled);
पूर्ण

पूर्णांक amplc_pc236_common_attach(काष्ठा comedi_device *dev, अचिन्हित दीर्घ iobase,
			      अचिन्हित पूर्णांक irq, अचिन्हित दीर्घ req_irq_flags)
अणु
	काष्ठा comedi_subdevice *s;
	पूर्णांक ret;

	dev->iobase = iobase;

	ret = comedi_alloc_subdevices(dev, 2);
	अगर (ret)
		वापस ret;

	s = &dev->subdevices[0];
	/* digital i/o subdevice (8255) */
	ret = subdev_8255_init(dev, s, शून्य, 0x00);
	अगर (ret)
		वापस ret;

	s = &dev->subdevices[1];
	dev->पढ़ो_subdev = s;
	s->type = COMEDI_SUBD_UNUSED;
	pc236_पूर्णांकr_update(dev, false);
	अगर (irq) अणु
		अगर (request_irq(irq, pc236_पूर्णांकerrupt, req_irq_flags,
				dev->board_name, dev) >= 0) अणु
			dev->irq = irq;
			s->type = COMEDI_SUBD_DI;
			s->subdev_flags = SDF_READABLE | SDF_CMD_READ;
			s->n_chan = 1;
			s->maxdata = 1;
			s->range_table = &range_digital;
			s->insn_bits = pc236_पूर्णांकr_insn;
			s->len_chanlist	= 1;
			s->करो_cmdtest = pc236_पूर्णांकr_cmdtest;
			s->करो_cmd = pc236_पूर्णांकr_cmd;
			s->cancel = pc236_पूर्णांकr_cancel;
		पूर्ण
	पूर्ण

	वापस 0;
पूर्ण
EXPORT_SYMBOL_GPL(amplc_pc236_common_attach);

अटल पूर्णांक __init amplc_pc236_common_init(व्योम)
अणु
	वापस 0;
पूर्ण
module_init(amplc_pc236_common_init);

अटल व्योम __निकास amplc_pc236_common_निकास(व्योम)
अणु
पूर्ण
module_निकास(amplc_pc236_common_निकास);

MODULE_AUTHOR("Comedi https://www.comedi.org");
MODULE_DESCRIPTION("Comedi helper for amplc_pc236 and amplc_pci236");
MODULE_LICENSE("GPL");
