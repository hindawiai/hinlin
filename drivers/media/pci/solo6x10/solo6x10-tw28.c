<शैली गुरु>
// SPDX-License-Identअगरier: GPL-2.0-or-later
/*
 * Copyright (C) 2010-2013 Bluecherry, LLC <https://www.bluecherrydvr.com>
 *
 * Original author:
 * Ben Collins <bcollins@ubuntu.com>
 *
 * Additional work by:
 * John Brooks <john.brooks@bluecherry.net>
 */

#समावेश <linux/kernel.h>
#समावेश <linux/delay.h>

#समावेश "solo6x10.h"
#समावेश "solo6x10-tw28.h"

#घोषणा DEFAULT_HDELAY_NTSC		(32 - 8)
#घोषणा DEFAULT_HACTIVE_NTSC		(720 + 16)
#घोषणा DEFAULT_VDELAY_NTSC		(7 - 2)
#घोषणा DEFAULT_VACTIVE_NTSC		(240 + 4)

#घोषणा DEFAULT_HDELAY_PAL		(32 + 4)
#घोषणा DEFAULT_HACTIVE_PAL		(864-DEFAULT_HDELAY_PAL)
#घोषणा DEFAULT_VDELAY_PAL		(6)
#घोषणा DEFAULT_VACTIVE_PAL		(312-DEFAULT_VDELAY_PAL)


अटल स्थिर u8 tbl_tw2864_ntsc_ढाँचा[] = अणु
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x00 */
	0x12, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x10 */
	0x12, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x20 */
	0x12, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x30 */
	0x12, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x40 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x50 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x60 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x70 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA3, 0x00,
	0x00, 0x02, 0x00, 0xcc, 0x00, 0x80, 0x44, 0x50, /* 0x80 */
	0x22, 0x01, 0xd8, 0xbc, 0xb8, 0x44, 0x38, 0x00,
	0x00, 0x78, 0x72, 0x3e, 0x14, 0xa5, 0xe4, 0x05, /* 0x90 */
	0x00, 0x28, 0x44, 0x44, 0xa0, 0x88, 0x5a, 0x01,
	0x08, 0x08, 0x08, 0x08, 0x1a, 0x1a, 0x1a, 0x1a, /* 0xa0 */
	0x00, 0x00, 0x00, 0xf0, 0xf0, 0xf0, 0xf0, 0x44,
	0x44, 0x0a, 0x00, 0xff, 0xef, 0xef, 0xef, 0xef, /* 0xb0 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xc0 */
	0x00, 0x00, 0x55, 0x00, 0xb1, 0xe4, 0x40, 0x00,
	0x77, 0x77, 0x01, 0x13, 0x57, 0x9b, 0xdf, 0x20, /* 0xd0 */
	0x64, 0xa8, 0xec, 0xc1, 0x0f, 0x11, 0x11, 0x81,
	0x00, 0xe0, 0xbb, 0xbb, 0x00, 0x11, 0x00, 0x00, /* 0xe0 */
	0x11, 0x00, 0x00, 0x11, 0x00, 0x00, 0x11, 0x00,
	0x83, 0xb5, 0x09, 0x78, 0x85, 0x00, 0x01, 0x20, /* 0xf0 */
	0x64, 0x11, 0x40, 0xaf, 0xff, 0x00, 0x00, 0x00,
पूर्ण;

अटल स्थिर u8 tbl_tw2864_pal_ढाँचा[] = अणु
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x00 */
	0x18, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x10 */
	0x18, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x20 */
	0x18, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x30 */
	0x18, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x40 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x50 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x60 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x70 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA3, 0x00,
	0x00, 0x02, 0x00, 0xcc, 0x00, 0x80, 0x44, 0x50, /* 0x80 */
	0x22, 0x01, 0xd8, 0xbc, 0xb8, 0x44, 0x38, 0x00,
	0x00, 0x78, 0x72, 0x3e, 0x14, 0xa5, 0xe4, 0x05, /* 0x90 */
	0x00, 0x28, 0x44, 0x44, 0xa0, 0x90, 0x5a, 0x01,
	0x0a, 0x0a, 0x0a, 0x0a, 0x1a, 0x1a, 0x1a, 0x1a, /* 0xa0 */
	0x00, 0x00, 0x00, 0xf0, 0xf0, 0xf0, 0xf0, 0x44,
	0x44, 0x0a, 0x00, 0xff, 0xef, 0xef, 0xef, 0xef, /* 0xb0 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xc0 */
	0x00, 0x00, 0x55, 0x00, 0xb1, 0xe4, 0x40, 0x00,
	0x77, 0x77, 0x01, 0x13, 0x57, 0x9b, 0xdf, 0x20, /* 0xd0 */
	0x64, 0xa8, 0xec, 0xc1, 0x0f, 0x11, 0x11, 0x81,
	0x00, 0xe0, 0xbb, 0xbb, 0x00, 0x11, 0x00, 0x00, /* 0xe0 */
	0x11, 0x00, 0x00, 0x11, 0x00, 0x00, 0x11, 0x00,
	0x83, 0xb5, 0x09, 0x00, 0xa0, 0x00, 0x01, 0x20, /* 0xf0 */
	0x64, 0x11, 0x40, 0xaf, 0xff, 0x00, 0x00, 0x00,
पूर्ण;

अटल स्थिर u8 tbl_tw2865_ntsc_ढाँचा[] = अणु
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x00 */
	0x12, 0xff, 0x09, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x10 */
	0x12, 0xff, 0x09, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x20 */
	0x12, 0xff, 0x09, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x48, 0x80, 0x80, 0x00, 0x02, /* 0x30 */
	0x12, 0xff, 0x09, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0x00, 0x90, 0x68, 0x00, 0x38, 0x80, 0x80, /* 0x40 */
	0x80, 0x80, 0x77, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x50 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x45, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x60 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x21, 0x43,
	0x08, 0x00, 0x00, 0x01, 0xf1, 0x03, 0xEF, 0x03, /* 0x70 */
	0xE9, 0x03, 0xD9, 0x15, 0x15, 0xE4, 0xA3, 0x80,
	0x00, 0x02, 0x00, 0xCC, 0x00, 0x80, 0x44, 0x50, /* 0x80 */
	0x22, 0x01, 0xD8, 0xBC, 0xB8, 0x44, 0x38, 0x00,
	0x00, 0x78, 0x44, 0x3D, 0x14, 0xA5, 0xE0, 0x05, /* 0x90 */
	0x00, 0x28, 0x44, 0x44, 0xA0, 0x90, 0x52, 0x13,
	0x08, 0x08, 0x08, 0x08, 0x1A, 0x1A, 0x1B, 0x1A, /* 0xa0 */
	0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x44,
	0x44, 0x4A, 0x00, 0xFF, 0xEF, 0xEF, 0xEF, 0xEF, /* 0xb0 */
	0xFF, 0xE7, 0xE9, 0xE9, 0xEB, 0xFF, 0xD6, 0xD8,
	0xD8, 0xD7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xc0 */
	0x00, 0x00, 0x55, 0x00, 0xE4, 0x39, 0x00, 0x80,
	0x77, 0x77, 0x03, 0x20, 0x57, 0x9b, 0xdf, 0x31, /* 0xd0 */
	0x64, 0xa8, 0xec, 0xd1, 0x0f, 0x11, 0x11, 0x81,
	0x10, 0xC0, 0xAA, 0xAA, 0x00, 0x11, 0x00, 0x00, /* 0xe0 */
	0x11, 0x00, 0x00, 0x11, 0x00, 0x00, 0x11, 0x00,
	0x83, 0xB5, 0x09, 0x78, 0x85, 0x00, 0x01, 0x20, /* 0xf0 */
	0x64, 0x51, 0x40, 0xaf, 0xFF, 0xF0, 0x00, 0xC0,
पूर्ण;

अटल स्थिर u8 tbl_tw2865_pal_ढाँचा[] = अणु
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x00 */
	0x11, 0xff, 0x01, 0xc3, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x10 */
	0x11, 0xff, 0x01, 0xc3, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x20 */
	0x11, 0xff, 0x01, 0xc3, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x30 */
	0x11, 0xff, 0x01, 0xc3, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0x94, 0x90, 0x48, 0x00, 0x38, 0x7F, 0x80, /* 0x40 */
	0x80, 0x80, 0x77, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x50 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x45, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x60 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x21, 0x43,
	0x08, 0x00, 0x00, 0x01, 0xf1, 0x03, 0xEF, 0x03, /* 0x70 */
	0xEA, 0x03, 0xD9, 0x15, 0x15, 0xE4, 0xA3, 0x80,
	0x00, 0x02, 0x00, 0xCC, 0x00, 0x80, 0x44, 0x50, /* 0x80 */
	0x22, 0x01, 0xD8, 0xBC, 0xB8, 0x44, 0x38, 0x00,
	0x00, 0x78, 0x44, 0x3D, 0x14, 0xA5, 0xE0, 0x05, /* 0x90 */
	0x00, 0x28, 0x44, 0x44, 0xA0, 0x90, 0x52, 0x13,
	0x08, 0x08, 0x08, 0x08, 0x1A, 0x1A, 0x1A, 0x1A, /* 0xa0 */
	0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x44,
	0x44, 0x4A, 0x00, 0xFF, 0xEF, 0xEF, 0xEF, 0xEF, /* 0xb0 */
	0xFF, 0xE7, 0xE9, 0xE9, 0xE9, 0xFF, 0xD7, 0xD8,
	0xD9, 0xD8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xc0 */
	0x00, 0x00, 0x55, 0x00, 0xE4, 0x39, 0x00, 0x80,
	0x77, 0x77, 0x03, 0x20, 0x57, 0x9b, 0xdf, 0x31, /* 0xd0 */
	0x64, 0xa8, 0xec, 0xd1, 0x0f, 0x11, 0x11, 0x81,
	0x10, 0xC0, 0xAA, 0xAA, 0x00, 0x11, 0x00, 0x00, /* 0xe0 */
	0x11, 0x00, 0x00, 0x11, 0x00, 0x00, 0x11, 0x00,
	0x83, 0xB5, 0x09, 0x00, 0xA0, 0x00, 0x01, 0x20, /* 0xf0 */
	0x64, 0x51, 0x40, 0xaf, 0xFF, 0xF0, 0x00, 0xC0,
पूर्ण;

#घोषणा is_tw286x(__solo, __id) (!(__solo->tw2815 & (1 << __id)))

अटल u8 tw_पढ़ोbyte(काष्ठा solo_dev *solo_dev, पूर्णांक chip_id, u8 tw6x_off,
		      u8 tw_off)
अणु
	अगर (is_tw286x(solo_dev, chip_id))
		वापस solo_i2c_पढ़ोbyte(solo_dev, SOLO_I2C_TW,
					 TW_CHIP_OFFSET_ADDR(chip_id),
					 tw6x_off);
	अन्यथा
		वापस solo_i2c_पढ़ोbyte(solo_dev, SOLO_I2C_TW,
					 TW_CHIP_OFFSET_ADDR(chip_id),
					 tw_off);
पूर्ण

अटल व्योम tw_ग_लिखोbyte(काष्ठा solo_dev *solo_dev, पूर्णांक chip_id,
			 u8 tw6x_off, u8 tw_off, u8 val)
अणु
	अगर (is_tw286x(solo_dev, chip_id))
		solo_i2c_ग_लिखोbyte(solo_dev, SOLO_I2C_TW,
				   TW_CHIP_OFFSET_ADDR(chip_id),
				   tw6x_off, val);
	अन्यथा
		solo_i2c_ग_लिखोbyte(solo_dev, SOLO_I2C_TW,
				   TW_CHIP_OFFSET_ADDR(chip_id),
				   tw_off, val);
पूर्ण

अटल व्योम tw_ग_लिखो_and_verअगरy(काष्ठा solo_dev *solo_dev, u8 addr, u8 off,
				u8 val)
अणु
	पूर्णांक i;

	क्रम (i = 0; i < 5; i++) अणु
		u8 rval = solo_i2c_पढ़ोbyte(solo_dev, SOLO_I2C_TW, addr, off);

		अगर (rval == val)
			वापस;

		solo_i2c_ग_लिखोbyte(solo_dev, SOLO_I2C_TW, addr, off, val);
		msleep_पूर्णांकerruptible(1);
	पूर्ण

/*	prपूर्णांकk("solo6x10/tw28: Error writing register: %02x->%02x [%02x]\n", */
/*		addr, off, val); */
पूर्ण

अटल पूर्णांक tw2865_setup(काष्ठा solo_dev *solo_dev, u8 dev_addr)
अणु
	u8 tbl_tw2865_common[256];
	पूर्णांक i;

	अगर (solo_dev->video_type == SOLO_VO_FMT_TYPE_PAL)
		स_नकल(tbl_tw2865_common, tbl_tw2865_pal_ढाँचा,
		       माप(tbl_tw2865_common));
	अन्यथा
		स_नकल(tbl_tw2865_common, tbl_tw2865_ntsc_ढाँचा,
		       माप(tbl_tw2865_common));

	/* ALINK Mode */
	अगर (solo_dev->nr_chans == 4) अणु
		tbl_tw2865_common[0xd2] = 0x01;
		tbl_tw2865_common[0xcf] = 0x00;
	पूर्ण अन्यथा अगर (solo_dev->nr_chans == 8) अणु
		tbl_tw2865_common[0xd2] = 0x02;
		अगर (dev_addr == TW_CHIP_OFFSET_ADDR(1))
			tbl_tw2865_common[0xcf] = 0x80;
	पूर्ण अन्यथा अगर (solo_dev->nr_chans == 16) अणु
		tbl_tw2865_common[0xd2] = 0x03;
		अगर (dev_addr == TW_CHIP_OFFSET_ADDR(1))
			tbl_tw2865_common[0xcf] = 0x83;
		अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(2))
			tbl_tw2865_common[0xcf] = 0x83;
		अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(3))
			tbl_tw2865_common[0xcf] = 0x80;
	पूर्ण

	क्रम (i = 0; i < 0xff; i++) अणु
		/* Skip पढ़ो only रेजिस्टरs */
		चयन (i) अणु
		हाल 0xb8 ... 0xc1:
		हाल 0xc4 ... 0xc7:
		हाल 0xfd:
			जारी;
		पूर्ण
		चयन (i & ~0x30) अणु
		हाल 0x00:
		हाल 0x0c ... 0x0d:
			जारी;
		पूर्ण

		tw_ग_लिखो_and_verअगरy(solo_dev, dev_addr, i,
				    tbl_tw2865_common[i]);
	पूर्ण

	वापस 0;
पूर्ण

अटल पूर्णांक tw2864_setup(काष्ठा solo_dev *solo_dev, u8 dev_addr)
अणु
	u8 tbl_tw2864_common[256];
	पूर्णांक i;

	अगर (solo_dev->video_type == SOLO_VO_FMT_TYPE_PAL)
		स_नकल(tbl_tw2864_common, tbl_tw2864_pal_ढाँचा,
		       माप(tbl_tw2864_common));
	अन्यथा
		स_नकल(tbl_tw2864_common, tbl_tw2864_ntsc_ढाँचा,
		       माप(tbl_tw2864_common));

	अगर (solo_dev->tw2865 == 0) अणु
		/* IRQ Mode */
		अगर (solo_dev->nr_chans == 4) अणु
			tbl_tw2864_common[0xd2] = 0x01;
			tbl_tw2864_common[0xcf] = 0x00;
		पूर्ण अन्यथा अगर (solo_dev->nr_chans == 8) अणु
			tbl_tw2864_common[0xd2] = 0x02;
			अगर (dev_addr == TW_CHIP_OFFSET_ADDR(0))
				tbl_tw2864_common[0xcf] = 0x43;
			अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(1))
				tbl_tw2864_common[0xcf] = 0x40;
		पूर्ण अन्यथा अगर (solo_dev->nr_chans == 16) अणु
			tbl_tw2864_common[0xd2] = 0x03;
			अगर (dev_addr == TW_CHIP_OFFSET_ADDR(0))
				tbl_tw2864_common[0xcf] = 0x43;
			अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(1))
				tbl_tw2864_common[0xcf] = 0x43;
			अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(2))
				tbl_tw2864_common[0xcf] = 0x43;
			अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(3))
				tbl_tw2864_common[0xcf] = 0x40;
		पूर्ण
	पूर्ण अन्यथा अणु
		/* ALINK Mode. Assumes that the first tw28xx is a
		 * 2865 and these are in cascade. */
		क्रम (i = 0; i <= 4; i++)
			tbl_tw2864_common[0x08 | i << 4] = 0x12;

		अगर (solo_dev->nr_chans == 8) अणु
			tbl_tw2864_common[0xd2] = 0x02;
			अगर (dev_addr == TW_CHIP_OFFSET_ADDR(1))
				tbl_tw2864_common[0xcf] = 0x80;
		पूर्ण अन्यथा अगर (solo_dev->nr_chans == 16) अणु
			tbl_tw2864_common[0xd2] = 0x03;
			अगर (dev_addr == TW_CHIP_OFFSET_ADDR(1))
				tbl_tw2864_common[0xcf] = 0x83;
			अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(2))
				tbl_tw2864_common[0xcf] = 0x83;
			अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(3))
				tbl_tw2864_common[0xcf] = 0x80;
		पूर्ण
	पूर्ण

	क्रम (i = 0; i < 0xff; i++) अणु
		/* Skip पढ़ो only रेजिस्टरs */
		चयन (i) अणु
		हाल 0xb8 ... 0xc1:
		हाल 0xfd:
			जारी;
		पूर्ण
		चयन (i & ~0x30) अणु
		हाल 0x00:
		हाल 0x0c:
		हाल 0x0d:
			जारी;
		पूर्ण

		tw_ग_लिखो_and_verअगरy(solo_dev, dev_addr, i,
				    tbl_tw2864_common[i]);
	पूर्ण

	वापस 0;
पूर्ण

अटल पूर्णांक tw2815_setup(काष्ठा solo_dev *solo_dev, u8 dev_addr)
अणु
	u8 tbl_ntsc_tw2815_common[] = अणु
		0x00, 0xc8, 0x20, 0xd0, 0x06, 0xf0, 0x08, 0x80,
		0x80, 0x80, 0x80, 0x02, 0x06, 0x00, 0x11,
	पूर्ण;

	u8 tbl_pal_tw2815_common[] = अणु
		0x00, 0x88, 0x20, 0xd0, 0x05, 0x20, 0x28, 0x80,
		0x80, 0x80, 0x80, 0x82, 0x06, 0x00, 0x11,
	पूर्ण;

	u8 tbl_tw2815_sfr[] = अणु
		0x00, 0x00, 0x00, 0xc0, 0x45, 0xa0, 0xd0, 0x2f, /* 0x00 */
		0x64, 0x80, 0x80, 0x82, 0x82, 0x00, 0x00, 0x00,
		0x00, 0x0f, 0x05, 0x00, 0x00, 0x80, 0x06, 0x00, /* 0x10 */
		0x00, 0x00, 0x00, 0xff, 0x8f, 0x00, 0x00, 0x00,
		0x88, 0x88, 0xc0, 0x00, 0x20, 0x64, 0xa8, 0xec, /* 0x20 */
		0x31, 0x75, 0xb9, 0xfd, 0x00, 0x00, 0x88, 0x88,
		0x88, 0x11, 0x00, 0x88, 0x88, 0x00,		/* 0x30 */
	पूर्ण;
	u8 *tbl_tw2815_common;
	पूर्णांक i;
	पूर्णांक ch;

	tbl_ntsc_tw2815_common[0x06] = 0;

	/* Horizontal Delay Control */
	tbl_ntsc_tw2815_common[0x02] = DEFAULT_HDELAY_NTSC & 0xff;
	tbl_ntsc_tw2815_common[0x06] |= 0x03 & (DEFAULT_HDELAY_NTSC >> 8);

	/* Horizontal Active Control */
	tbl_ntsc_tw2815_common[0x03] = DEFAULT_HACTIVE_NTSC & 0xff;
	tbl_ntsc_tw2815_common[0x06] |=
		((0x03 & (DEFAULT_HACTIVE_NTSC >> 8)) << 2);

	/* Vertical Delay Control */
	tbl_ntsc_tw2815_common[0x04] = DEFAULT_VDELAY_NTSC & 0xff;
	tbl_ntsc_tw2815_common[0x06] |=
		((0x01 & (DEFAULT_VDELAY_NTSC >> 8)) << 4);

	/* Vertical Active Control */
	tbl_ntsc_tw2815_common[0x05] = DEFAULT_VACTIVE_NTSC & 0xff;
	tbl_ntsc_tw2815_common[0x06] |=
		((0x01 & (DEFAULT_VACTIVE_NTSC >> 8)) << 5);

	tbl_pal_tw2815_common[0x06] = 0;

	/* Horizontal Delay Control */
	tbl_pal_tw2815_common[0x02] = DEFAULT_HDELAY_PAL & 0xff;
	tbl_pal_tw2815_common[0x06] |= 0x03 & (DEFAULT_HDELAY_PAL >> 8);

	/* Horizontal Active Control */
	tbl_pal_tw2815_common[0x03] = DEFAULT_HACTIVE_PAL & 0xff;
	tbl_pal_tw2815_common[0x06] |=
		((0x03 & (DEFAULT_HACTIVE_PAL >> 8)) << 2);

	/* Vertical Delay Control */
	tbl_pal_tw2815_common[0x04] = DEFAULT_VDELAY_PAL & 0xff;
	tbl_pal_tw2815_common[0x06] |=
		((0x01 & (DEFAULT_VDELAY_PAL >> 8)) << 4);

	/* Vertical Active Control */
	tbl_pal_tw2815_common[0x05] = DEFAULT_VACTIVE_PAL & 0xff;
	tbl_pal_tw2815_common[0x06] |=
		((0x01 & (DEFAULT_VACTIVE_PAL >> 8)) << 5);

	tbl_tw2815_common =
	    (solo_dev->video_type == SOLO_VO_FMT_TYPE_NTSC) ?
	     tbl_ntsc_tw2815_common : tbl_pal_tw2815_common;

	/* Dual ITU-R BT.656 क्रमmat */
	tbl_tw2815_common[0x0d] |= 0x04;

	/* Audio configuration */
	tbl_tw2815_sfr[0x62 - 0x40] &= ~(3 << 6);

	अगर (solo_dev->nr_chans == 4) अणु
		tbl_tw2815_sfr[0x63 - 0x40] |= 1;
		tbl_tw2815_sfr[0x62 - 0x40] |= 3 << 6;
	पूर्ण अन्यथा अगर (solo_dev->nr_chans == 8) अणु
		tbl_tw2815_sfr[0x63 - 0x40] |= 2;
		अगर (dev_addr == TW_CHIP_OFFSET_ADDR(0))
			tbl_tw2815_sfr[0x62 - 0x40] |= 1 << 6;
		अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(1))
			tbl_tw2815_sfr[0x62 - 0x40] |= 2 << 6;
	पूर्ण अन्यथा अगर (solo_dev->nr_chans == 16) अणु
		tbl_tw2815_sfr[0x63 - 0x40] |= 3;
		अगर (dev_addr == TW_CHIP_OFFSET_ADDR(0))
			tbl_tw2815_sfr[0x62 - 0x40] |= 1 << 6;
		अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(1))
			tbl_tw2815_sfr[0x62 - 0x40] |= 0 << 6;
		अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(2))
			tbl_tw2815_sfr[0x62 - 0x40] |= 0 << 6;
		अन्यथा अगर (dev_addr == TW_CHIP_OFFSET_ADDR(3))
			tbl_tw2815_sfr[0x62 - 0x40] |= 2 << 6;
	पूर्ण

	/* Output mode of R_ADATM pin (0 mixing, 1 record) */
	/* tbl_tw2815_sfr[0x63 - 0x40] |= 0 << 2; */

	/* 8KHz, used to be 16KHz, but changed क्रम remote client compat */
	tbl_tw2815_sfr[0x62 - 0x40] |= 0 << 2;
	tbl_tw2815_sfr[0x6c - 0x40] |= 0 << 2;

	/* Playback of right channel */
	tbl_tw2815_sfr[0x6c - 0x40] |= 1 << 5;

	/* Reserved value (XXX ??) */
	tbl_tw2815_sfr[0x5c - 0x40] |= 1 << 5;

	/* Analog output gain and mix ratio playback on full */
	tbl_tw2815_sfr[0x70 - 0x40] |= 0xff;
	/* Select playback audio and mute all except */
	tbl_tw2815_sfr[0x71 - 0x40] |= 0x10;
	tbl_tw2815_sfr[0x6d - 0x40] |= 0x0f;

	/* End of audio configuration */

	क्रम (ch = 0; ch < 4; ch++) अणु
		tbl_tw2815_common[0x0d] &= ~3;
		चयन (ch) अणु
		हाल 0:
			tbl_tw2815_common[0x0d] |= 0x21;
			अवरोध;
		हाल 1:
			tbl_tw2815_common[0x0d] |= 0x20;
			अवरोध;
		हाल 2:
			tbl_tw2815_common[0x0d] |= 0x23;
			अवरोध;
		हाल 3:
			tbl_tw2815_common[0x0d] |= 0x22;
			अवरोध;
		पूर्ण

		क्रम (i = 0; i < 0x0f; i++) अणु
			अगर (i == 0x00)
				जारी;	/* पढ़ो-only */
			solo_i2c_ग_लिखोbyte(solo_dev, SOLO_I2C_TW,
					   dev_addr, (ch * 0x10) + i,
					   tbl_tw2815_common[i]);
		पूर्ण
	पूर्ण

	क्रम (i = 0x40; i < 0x76; i++) अणु
		/* Skip पढ़ो-only and nop रेजिस्टरs */
		अगर (i == 0x40 || i == 0x59 || i == 0x5a ||
		    i == 0x5d || i == 0x5e || i == 0x5f)
			जारी;

		solo_i2c_ग_लिखोbyte(solo_dev, SOLO_I2C_TW, dev_addr, i,
				       tbl_tw2815_sfr[i - 0x40]);
	पूर्ण

	वापस 0;
पूर्ण

#घोषणा FIRST_ACTIVE_LINE	0x0008
#घोषणा LAST_ACTIVE_LINE	0x0102

अटल व्योम saa712x_ग_लिखो_regs(काष्ठा solo_dev *dev, स्थिर u8 *vals,
		पूर्णांक start, पूर्णांक n)
अणु
	क्रम (; start < n; start++, vals++) अणु
		/* Skip पढ़ो-only रेजिस्टरs */
		चयन (start) अणु
		/* हाल 0x00 ... 0x25: */
		हाल 0x2e ... 0x37:
		हाल 0x60:
		हाल 0x7d:
			जारी;
		पूर्ण
		solo_i2c_ग_लिखोbyte(dev, SOLO_I2C_SAA, 0x46, start, *vals);
	पूर्ण
पूर्ण

#घोषणा SAA712x_reg7c (0x80 | ((LAST_ACTIVE_LINE & 0x100) >> 2) \
		| ((FIRST_ACTIVE_LINE & 0x100) >> 4))

अटल व्योम saa712x_setup(काष्ठा solo_dev *dev)
अणु
	स्थिर पूर्णांक reg_start = 0x26;
	अटल स्थिर u8 saa7128_regs_ntsc[] = अणु
	/* :0x26 */
		0x0d, 0x00,
	/* :0x28 */
		0x59, 0x1d, 0x75, 0x3f, 0x06, 0x3f,
	/* :0x2e XXX: पढ़ो-only */
		0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* :0x38 */
		0x1a, 0x1a, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* :0x40 */
		0x00, 0x00, 0x00, 0x68, 0x10, 0x97, 0x4c, 0x18,
		0x9b, 0x93, 0x9f, 0xff, 0x7c, 0x34, 0x3f, 0x3f,
	/* :0x50 */
		0x3f, 0x83, 0x83, 0x80, 0x0d, 0x0f, 0xc3, 0x06,
		0x02, 0x80, 0x71, 0x77, 0xa7, 0x67, 0x66, 0x2e,
	/* :0x60 */
		0x7b, 0x11, 0x4f, 0x1f, 0x7c, 0xf0, 0x21, 0x77,
		0x41, 0x88, 0x41, 0x52, 0xed, 0x10, 0x10, 0x00,
	/* :0x70 */
		0x41, 0xc3, 0x00, 0x3e, 0xb8, 0x02, 0x00, 0x00,
		0x00, 0x00, FIRST_ACTIVE_LINE, LAST_ACTIVE_LINE & 0xff,
		SAA712x_reg7c, 0x00, 0xff, 0xff,
	पूर्ण, saa7128_regs_pal[] = अणु
	/* :0x26 */
		0x0d, 0x00,
	/* :0x28 */
		0xe1, 0x1d, 0x75, 0x3f, 0x06, 0x3f,
	/* :0x2e XXX: पढ़ो-only */
		0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* :0x38 */
		0x1a, 0x1a, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* :0x40 */
		0x00, 0x00, 0x00, 0x68, 0x10, 0x97, 0x4c, 0x18,
		0x9b, 0x93, 0x9f, 0xff, 0x7c, 0x34, 0x3f, 0x3f,
	/* :0x50 */
		0x3f, 0x83, 0x83, 0x80, 0x0d, 0x0f, 0xc3, 0x06,
		0x02, 0x80, 0x0f, 0x77, 0xa7, 0x67, 0x66, 0x2e,
	/* :0x60 */
		0x7b, 0x02, 0x35, 0xcb, 0x8a, 0x09, 0x2a, 0x77,
		0x41, 0x88, 0x41, 0x52, 0xf1, 0x10, 0x20, 0x00,
	/* :0x70 */
		0x41, 0xc3, 0x00, 0x3e, 0xb8, 0x02, 0x00, 0x00,
		0x00, 0x00, 0x12, 0x30,
		SAA712x_reg7c | 0x40, 0x00, 0xff, 0xff,
	पूर्ण;

	अगर (dev->video_type == SOLO_VO_FMT_TYPE_PAL)
		saa712x_ग_लिखो_regs(dev, saa7128_regs_pal, reg_start,
				माप(saa7128_regs_pal));
	अन्यथा
		saa712x_ग_लिखो_regs(dev, saa7128_regs_ntsc, reg_start,
				माप(saa7128_regs_ntsc));
पूर्ण

पूर्णांक solo_tw28_init(काष्ठा solo_dev *solo_dev)
अणु
	पूर्णांक i;
	u8 value;

	solo_dev->tw28_cnt = 0;

	/* Detect techwell chip type(s) */
	क्रम (i = 0; i < solo_dev->nr_chans / 4; i++) अणु
		value = solo_i2c_पढ़ोbyte(solo_dev, SOLO_I2C_TW,
					  TW_CHIP_OFFSET_ADDR(i), 0xFF);

		चयन (value >> 3) अणु
		हाल 0x18:
			solo_dev->tw2865 |= 1 << i;
			solo_dev->tw28_cnt++;
			अवरोध;
		हाल 0x0c:
		हाल 0x0d:
			solo_dev->tw2864 |= 1 << i;
			solo_dev->tw28_cnt++;
			अवरोध;
		शेष:
			value = solo_i2c_पढ़ोbyte(solo_dev, SOLO_I2C_TW,
						  TW_CHIP_OFFSET_ADDR(i),
						  0x59);
			अगर ((value >> 3) == 0x04) अणु
				solo_dev->tw2815 |= 1 << i;
				solo_dev->tw28_cnt++;
			पूर्ण
		पूर्ण
	पूर्ण

	अगर (solo_dev->tw28_cnt != (solo_dev->nr_chans >> 2)) अणु
		dev_err(&solo_dev->pdev->dev,
			"Could not initialize any techwell chips\n");
		वापस -EINVAL;
	पूर्ण

	saa712x_setup(solo_dev);

	क्रम (i = 0; i < solo_dev->tw28_cnt; i++) अणु
		अगर ((solo_dev->tw2865 & (1 << i)))
			tw2865_setup(solo_dev, TW_CHIP_OFFSET_ADDR(i));
		अन्यथा अगर ((solo_dev->tw2864 & (1 << i)))
			tw2864_setup(solo_dev, TW_CHIP_OFFSET_ADDR(i));
		अन्यथा
			tw2815_setup(solo_dev, TW_CHIP_OFFSET_ADDR(i));
	पूर्ण

	वापस 0;
पूर्ण

/*
 * We accessed the video status संकेत in the Techwell chip through
 * iic/i2c because the video status reported by रेजिस्टर REG_VI_STATUS1
 * (address 0x012C) of the SOLO6010 chip करोesn't give the correct video
 * status संकेत values.
 */
पूर्णांक tw28_get_video_status(काष्ठा solo_dev *solo_dev, u8 ch)
अणु
	u8 val, chip_num;

	/* Get the right chip and on-chip channel */
	chip_num = ch / 4;
	ch %= 4;

	val = tw_पढ़ोbyte(solo_dev, chip_num, TW286x_AV_STAT_ADDR,
			  TW_AV_STAT_ADDR) & 0x0f;

	वापस val & (1 << ch) ? 1 : 0;
पूर्ण

#अगर 0
/* Status of audio from up to 4 techwell chips are combined पूर्णांकo 1 variable.
 * See techwell datasheet क्रम details. */
u16 tw28_get_audio_status(काष्ठा solo_dev *solo_dev)
अणु
	u8 val;
	u16 status = 0;
	पूर्णांक i;

	क्रम (i = 0; i < solo_dev->tw28_cnt; i++) अणु
		val = (tw_पढ़ोbyte(solo_dev, i, TW286x_AV_STAT_ADDR,
				   TW_AV_STAT_ADDR) & 0xf0) >> 4;
		status |= val << (i * 4);
	पूर्ण

	वापस status;
पूर्ण
#पूर्ण_अगर

bool tw28_has_sharpness(काष्ठा solo_dev *solo_dev, u8 ch)
अणु
	वापस is_tw286x(solo_dev, ch / 4);
पूर्ण

पूर्णांक tw28_set_ctrl_val(काष्ठा solo_dev *solo_dev, u32 ctrl, u8 ch,
		      s32 val)
अणु
	अक्षर sval;
	u8 chip_num;

	/* Get the right chip and on-chip channel */
	chip_num = ch / 4;
	ch %= 4;

	अगर (val > 255 || val < 0)
		वापस -दुस्फल;

	चयन (ctrl) अणु
	हाल V4L2_CID_SHARPNESS:
		/* Only 286x has sharpness */
		अगर (is_tw286x(solo_dev, chip_num)) अणु
			u8 v = solo_i2c_पढ़ोbyte(solo_dev, SOLO_I2C_TW,
						 TW_CHIP_OFFSET_ADDR(chip_num),
						 TW286x_SHARPNESS(chip_num));
			v &= 0xf0;
			v |= val;
			solo_i2c_ग_लिखोbyte(solo_dev, SOLO_I2C_TW,
					   TW_CHIP_OFFSET_ADDR(chip_num),
					   TW286x_SHARPNESS(chip_num), v);
		पूर्ण अन्यथा अणु
			वापस -EINVAL;
		पूर्ण
		अवरोध;

	हाल V4L2_CID_HUE:
		अगर (is_tw286x(solo_dev, chip_num))
			sval = val - 128;
		अन्यथा
			sval = (अक्षर)val;
		tw_ग_लिखोbyte(solo_dev, chip_num, TW286x_HUE_ADDR(ch),
			     TW_HUE_ADDR(ch), sval);

		अवरोध;

	हाल V4L2_CID_SATURATION:
		/* 286x chips have a U and V component क्रम saturation */
		अगर (is_tw286x(solo_dev, chip_num)) अणु
			solo_i2c_ग_लिखोbyte(solo_dev, SOLO_I2C_TW,
					   TW_CHIP_OFFSET_ADDR(chip_num),
					   TW286x_SATURATIONU_ADDR(ch), val);
		पूर्ण
		tw_ग_लिखोbyte(solo_dev, chip_num, TW286x_SATURATIONV_ADDR(ch),
			     TW_SATURATION_ADDR(ch), val);

		अवरोध;

	हाल V4L2_CID_CONTRAST:
		tw_ग_लिखोbyte(solo_dev, chip_num, TW286x_CONTRAST_ADDR(ch),
			     TW_CONTRAST_ADDR(ch), val);
		अवरोध;

	हाल V4L2_CID_BRIGHTNESS:
		अगर (is_tw286x(solo_dev, chip_num))
			sval = val - 128;
		अन्यथा
			sval = (अक्षर)val;
		tw_ग_लिखोbyte(solo_dev, chip_num, TW286x_BRIGHTNESS_ADDR(ch),
			     TW_BRIGHTNESS_ADDR(ch), sval);

		अवरोध;
	शेष:
		वापस -EINVAL;
	पूर्ण

	वापस 0;
पूर्ण

पूर्णांक tw28_get_ctrl_val(काष्ठा solo_dev *solo_dev, u32 ctrl, u8 ch,
		      s32 *val)
अणु
	u8 rval, chip_num;

	/* Get the right chip and on-chip channel */
	chip_num = ch / 4;
	ch %= 4;

	चयन (ctrl) अणु
	हाल V4L2_CID_SHARPNESS:
		/* Only 286x has sharpness */
		अगर (is_tw286x(solo_dev, chip_num)) अणु
			rval = solo_i2c_पढ़ोbyte(solo_dev, SOLO_I2C_TW,
						 TW_CHIP_OFFSET_ADDR(chip_num),
						 TW286x_SHARPNESS(chip_num));
			*val = rval & 0x0f;
		पूर्ण अन्यथा
			*val = 0;
		अवरोध;
	हाल V4L2_CID_HUE:
		rval = tw_पढ़ोbyte(solo_dev, chip_num, TW286x_HUE_ADDR(ch),
				   TW_HUE_ADDR(ch));
		अगर (is_tw286x(solo_dev, chip_num))
			*val = (s32)((अक्षर)rval) + 128;
		अन्यथा
			*val = rval;
		अवरोध;
	हाल V4L2_CID_SATURATION:
		*val = tw_पढ़ोbyte(solo_dev, chip_num,
				   TW286x_SATURATIONU_ADDR(ch),
				   TW_SATURATION_ADDR(ch));
		अवरोध;
	हाल V4L2_CID_CONTRAST:
		*val = tw_पढ़ोbyte(solo_dev, chip_num,
				   TW286x_CONTRAST_ADDR(ch),
				   TW_CONTRAST_ADDR(ch));
		अवरोध;
	हाल V4L2_CID_BRIGHTNESS:
		rval = tw_पढ़ोbyte(solo_dev, chip_num,
				   TW286x_BRIGHTNESS_ADDR(ch),
				   TW_BRIGHTNESS_ADDR(ch));
		अगर (is_tw286x(solo_dev, chip_num))
			*val = (s32)((अक्षर)rval) + 128;
		अन्यथा
			*val = rval;
		अवरोध;
	शेष:
		वापस -EINVAL;
	पूर्ण

	वापस 0;
पूर्ण

#अगर 0
/*
 * For audio output volume, the output channel is only 1. In this हाल we
 * करोn't need to offset TW_CHIP_OFFSET_ADDR. The TW_CHIP_OFFSET_ADDR used
 * is the base address of the techwell chip.
 */
व्योम tw2815_Set_AudioOutVol(काष्ठा solo_dev *solo_dev, अचिन्हित पूर्णांक u_val)
अणु
	अचिन्हित पूर्णांक val;
	अचिन्हित पूर्णांक chip_num;

	chip_num = (solo_dev->nr_chans - 1) / 4;

	val = tw_पढ़ोbyte(solo_dev, chip_num, TW286x_AUDIO_OUTPUT_VOL_ADDR,
			  TW_AUDIO_OUTPUT_VOL_ADDR);

	u_val = (val & 0x0f) | (u_val << 4);

	tw_ग_लिखोbyte(solo_dev, chip_num, TW286x_AUDIO_OUTPUT_VOL_ADDR,
		     TW_AUDIO_OUTPUT_VOL_ADDR, u_val);
पूर्ण
#पूर्ण_अगर

u8 tw28_get_audio_gain(काष्ठा solo_dev *solo_dev, u8 ch)
अणु
	u8 val;
	u8 chip_num;

	/* Get the right chip and on-chip channel */
	chip_num = ch / 4;
	ch %= 4;

	val = tw_पढ़ोbyte(solo_dev, chip_num,
			  TW286x_AUDIO_INPUT_GAIN_ADDR(ch),
			  TW_AUDIO_INPUT_GAIN_ADDR(ch));

	वापस (ch % 2) ? (val >> 4) : (val & 0x0f);
पूर्ण

व्योम tw28_set_audio_gain(काष्ठा solo_dev *solo_dev, u8 ch, u8 val)
अणु
	u8 old_val;
	u8 chip_num;

	/* Get the right chip and on-chip channel */
	chip_num = ch / 4;
	ch %= 4;

	old_val = tw_पढ़ोbyte(solo_dev, chip_num,
			      TW286x_AUDIO_INPUT_GAIN_ADDR(ch),
			      TW_AUDIO_INPUT_GAIN_ADDR(ch));

	val = (old_val & ((ch % 2) ? 0x0f : 0xf0)) |
		((ch % 2) ? (val << 4) : val);

	tw_ग_लिखोbyte(solo_dev, chip_num, TW286x_AUDIO_INPUT_GAIN_ADDR(ch),
		     TW_AUDIO_INPUT_GAIN_ADDR(ch), val);
पूर्ण
