<शैली गुरु>
// SPDX-License-Identअगरier: GPL-2.0-or-later
/*
 * budget-patch.c: driver क्रम Budget Patch,
 * hardware modअगरication of DVB-S cards enabling full TS
 *
 * Written by Emard <emard@softhome.net>
 *
 * Original idea by Roberto Deza <rdeza@unav.es>
 *
 * Special thanks to Holger Waechtler, Michael Hunold, Marian Durkovic
 * and Metzlerbros
 *
 * the project's page is at https://linuxtv.org
 */

#समावेश "av7110.h"
#समावेश "av7110_hw.h"
#समावेश "budget.h"
#समावेश "stv0299.h"
#समावेश "ves1x93.h"
#समावेश "tda8083.h"

#समावेश "bsru6.h"

DVB_DEFINE_MOD_OPT_ADAPTER_NR(adapter_nr);

#घोषणा budget_patch budget

अटल काष्ठा saa7146_extension budget_extension;

MAKE_BUDGET_INFO(ttbp, "TT-Budget/Patch DVB-S 1.x PCI", BUDGET_PATCH);
//MAKE_BUDGET_INFO(satel,"TT-Budget/Patch SATELCO PCI", BUDGET_TT_HW_DISEQC);

अटल स्थिर काष्ठा pci_device_id pci_tbl[] = अणु
	MAKE_EXTENSION_PCI(ttbp,0x13c2, 0x0000),
//        MAKE_EXTENSION_PCI(satel, 0x13c2, 0x1013),
	अणु
		.venकरोr    = 0,
	पूर्ण
पूर्ण;

/* those lines are क्रम budget-patch to be tried
** on a true budget card and observe the
** behaviour of VSYNC generated by rps1.
** this code was shamelessly copy/pasted from budget.c
*/
अटल व्योम gpio_Set22K (काष्ठा budget *budget, पूर्णांक state)
अणु
	काष्ठा saa7146_dev *dev=budget->dev;
	dprपूर्णांकk(2, "budget: %p\n", budget);
	saa7146_setgpio(dev, 3, (state ? SAA7146_GPIO_OUTHI : SAA7146_GPIO_OUTLO));
पूर्ण

/* Diseqc functions only क्रम TT Budget card */
/* taken from the Skyvision DVB driver by
   Ralph Metzler <rjkm@metzlerbros.de> */

अटल व्योम DiseqcSendBit (काष्ठा budget *budget, पूर्णांक data)
अणु
	काष्ठा saa7146_dev *dev=budget->dev;
	dprपूर्णांकk(2, "budget: %p\n", budget);

	saa7146_setgpio(dev, 3, SAA7146_GPIO_OUTHI);
	udelay(data ? 500 : 1000);
	saa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);
	udelay(data ? 1000 : 500);
पूर्ण

अटल व्योम DiseqcSendByte (काष्ठा budget *budget, पूर्णांक data)
अणु
	पूर्णांक i, par=1, d;

	dprपूर्णांकk(2, "budget: %p\n", budget);

	क्रम (i=7; i>=0; i--) अणु
		d = (data>>i)&1;
		par ^= d;
		DiseqcSendBit(budget, d);
	पूर्ण

	DiseqcSendBit(budget, par);
पूर्ण

अटल पूर्णांक SendDiSEqCMsg (काष्ठा budget *budget, पूर्णांक len, u8 *msg, अचिन्हित दीर्घ burst)
अणु
	काष्ठा saa7146_dev *dev=budget->dev;
	पूर्णांक i;

	dprपूर्णांकk(2, "budget: %p\n", budget);

	saa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);
	mdelay(16);

	क्रम (i=0; i<len; i++)
		DiseqcSendByte(budget, msg[i]);

	mdelay(16);

	अगर (burst!=-1) अणु
		अगर (burst)
			DiseqcSendByte(budget, 0xff);
		अन्यथा अणु
			saa7146_setgpio(dev, 3, SAA7146_GPIO_OUTHI);
			mdelay(12);
			udelay(500);
			saa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);
		पूर्ण
		msleep(20);
	पूर्ण

	वापस 0;
पूर्ण

/* shamelessly copy/pasted from budget.c */
अटल पूर्णांक budget_set_tone(काष्ठा dvb_frontend *fe,
			   क्रमागत fe_sec_tone_mode tone)
अणु
	काष्ठा budget* budget = (काष्ठा budget*) fe->dvb->priv;

	चयन (tone) अणु
	हाल SEC_TONE_ON:
		gpio_Set22K (budget, 1);
		अवरोध;

	हाल SEC_TONE_OFF:
		gpio_Set22K (budget, 0);
		अवरोध;

	शेष:
		वापस -EINVAL;
	पूर्ण

	वापस 0;
पूर्ण

अटल पूर्णांक budget_diseqc_send_master_cmd(काष्ठा dvb_frontend* fe, काष्ठा dvb_diseqc_master_cmd* cmd)
अणु
	काष्ठा budget* budget = (काष्ठा budget*) fe->dvb->priv;

	SendDiSEqCMsg (budget, cmd->msg_len, cmd->msg, 0);

	वापस 0;
पूर्ण

अटल पूर्णांक budget_diseqc_send_burst(काष्ठा dvb_frontend *fe,
				    क्रमागत fe_sec_mini_cmd minicmd)
अणु
	काष्ठा budget* budget = (काष्ठा budget*) fe->dvb->priv;

	SendDiSEqCMsg (budget, 0, शून्य, minicmd);

	वापस 0;
पूर्ण

अटल पूर्णांक budget_av7110_send_fw_cmd(काष्ठा budget_patch *budget, u16* buf, पूर्णांक length)
अणु
	पूर्णांक i;

	dprपूर्णांकk(2, "budget: %p\n", budget);

	क्रम (i = 2; i < length; i++)
	अणु
		  ttpci_budget_debiग_लिखो(budget, DEBINOSWAP, COMMAND + 2*i, 2, (u32) buf[i], 0,0);
		  msleep(5);
	पूर्ण
	अगर (length)
		  ttpci_budget_debiग_लिखो(budget, DEBINOSWAP, COMMAND + 2, 2, (u32) buf[1], 0,0);
	अन्यथा
		  ttpci_budget_debiग_लिखो(budget, DEBINOSWAP, COMMAND + 2, 2, 0, 0,0);
	msleep(5);
	ttpci_budget_debiग_लिखो(budget, DEBINOSWAP, COMMAND, 2, (u32) buf[0], 0,0);
	msleep(5);
	वापस 0;
पूर्ण

अटल व्योम av7110_set22k(काष्ठा budget_patch *budget, पूर्णांक state)
अणु
	u16 buf[2] = अणु( COMTYPE_AUDIODAC << 8) | (state ? ON22K : OFF22K), 0पूर्ण;

	dprपूर्णांकk(2, "budget: %p\n", budget);
	budget_av7110_send_fw_cmd(budget, buf, 2);
पूर्ण

अटल पूर्णांक av7110_send_diseqc_msg(काष्ठा budget_patch *budget, पूर्णांक len, u8 *msg, पूर्णांक burst)
अणु
	पूर्णांक i;
	u16 buf[18] = अणु ((COMTYPE_AUDIODAC << 8) | SendDiSEqC),
		16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 पूर्ण;

	dprपूर्णांकk(2, "budget: %p\n", budget);

	अगर (len>10)
		len=10;

	buf[1] = len+2;
	buf[2] = len;

	अगर (burst != -1)
		buf[3]=burst ? 0x01 : 0x00;
	अन्यथा
		buf[3]=0xffff;

	क्रम (i=0; i<len; i++)
		buf[i+4]=msg[i];

	budget_av7110_send_fw_cmd(budget, buf, 18);
	वापस 0;
पूर्ण

अटल पूर्णांक budget_patch_set_tone(काष्ठा dvb_frontend *fe,
				 क्रमागत fe_sec_tone_mode tone)
अणु
	काष्ठा budget_patch* budget = (काष्ठा budget_patch*) fe->dvb->priv;

	चयन (tone) अणु
	हाल SEC_TONE_ON:
		av7110_set22k (budget, 1);
		अवरोध;

	हाल SEC_TONE_OFF:
		av7110_set22k (budget, 0);
		अवरोध;

	शेष:
		वापस -EINVAL;
	पूर्ण

	वापस 0;
पूर्ण

अटल पूर्णांक budget_patch_diseqc_send_master_cmd(काष्ठा dvb_frontend* fe, काष्ठा dvb_diseqc_master_cmd* cmd)
अणु
	काष्ठा budget_patch* budget = (काष्ठा budget_patch*) fe->dvb->priv;

	av7110_send_diseqc_msg (budget, cmd->msg_len, cmd->msg, 0);

	वापस 0;
पूर्ण

अटल पूर्णांक budget_patch_diseqc_send_burst(काष्ठा dvb_frontend *fe,
					  क्रमागत fe_sec_mini_cmd minicmd)
अणु
	काष्ठा budget_patch* budget = (काष्ठा budget_patch*) fe->dvb->priv;

	av7110_send_diseqc_msg (budget, 0, शून्य, minicmd);

	वापस 0;
पूर्ण

अटल पूर्णांक alps_bsrv2_tuner_set_params(काष्ठा dvb_frontend *fe)
अणु
	काष्ठा dtv_frontend_properties *p = &fe->dtv_property_cache;
	काष्ठा budget_patch* budget = (काष्ठा budget_patch*) fe->dvb->priv;
	u8 pwr = 0;
	u8 buf[4];
	काष्ठा i2c_msg msg = अणु .addr = 0x61, .flags = 0, .buf = buf, .len = माप(buf) पूर्ण;
	u32 भाग = (p->frequency + 479500) / 125;

	अगर (p->frequency > 2000000)
		pwr = 3;
	अन्यथा अगर (p->frequency > 1800000)
		pwr = 2;
	अन्यथा अगर (p->frequency > 1600000)
		pwr = 1;
	अन्यथा अगर (p->frequency > 1200000)
		pwr = 0;
	अन्यथा अगर (p->frequency >= 1100000)
		pwr = 1;
	अन्यथा pwr = 2;

	buf[0] = (भाग >> 8) & 0x7f;
	buf[1] = भाग & 0xff;
	buf[2] = ((भाग & 0x18000) >> 10) | 0x95;
	buf[3] = (pwr << 6) | 0x30;

	// NOTE: since we're using a prescaler of 2, we set the
	// भागisor frequency to 62.5kHz and भागide by 125 above

	अगर (fe->ops.i2c_gate_ctrl)
		fe->ops.i2c_gate_ctrl(fe, 1);
	अगर (i2c_transfer (&budget->i2c_adap, &msg, 1) != 1)
		वापस -EIO;
	वापस 0;
पूर्ण

अटल काष्ठा ves1x93_config alps_bsrv2_config = अणु
	.demod_address = 0x08,
	.xin = 90100000UL,
	.invert_pwm = 0,
पूर्ण;

अटल पूर्णांक grundig_29504_451_tuner_set_params(काष्ठा dvb_frontend *fe)
अणु
	काष्ठा dtv_frontend_properties *p = &fe->dtv_property_cache;
	काष्ठा budget_patch* budget = (काष्ठा budget_patch*) fe->dvb->priv;
	u32 भाग;
	u8 data[4];
	काष्ठा i2c_msg msg = अणु .addr = 0x61, .flags = 0, .buf = data, .len = माप(data) पूर्ण;

	भाग = p->frequency / 125;
	data[0] = (भाग >> 8) & 0x7f;
	data[1] = भाग & 0xff;
	data[2] = 0x8e;
	data[3] = 0x00;

	अगर (fe->ops.i2c_gate_ctrl)
		fe->ops.i2c_gate_ctrl(fe, 1);
	अगर (i2c_transfer (&budget->i2c_adap, &msg, 1) != 1)
		वापस -EIO;
	वापस 0;
पूर्ण

अटल काष्ठा tda8083_config grundig_29504_451_config = अणु
	.demod_address = 0x68,
पूर्ण;

अटल व्योम frontend_init(काष्ठा budget_patch* budget)
अणु
	चयन(budget->dev->pci->subप्रणाली_device) अणु
	हाल 0x0000: // Hauppauge/TT WinTV DVB-S rev1.X
	हाल 0x1013: // SATELCO Mulसमयdia PCI

		// try the ALPS BSRV2 first of all
		budget->dvb_frontend = dvb_attach(ves1x93_attach, &alps_bsrv2_config, &budget->i2c_adap);
		अगर (budget->dvb_frontend) अणु
			budget->dvb_frontend->ops.tuner_ops.set_params = alps_bsrv2_tuner_set_params;
			budget->dvb_frontend->ops.diseqc_send_master_cmd = budget_patch_diseqc_send_master_cmd;
			budget->dvb_frontend->ops.diseqc_send_burst = budget_patch_diseqc_send_burst;
			budget->dvb_frontend->ops.set_tone = budget_patch_set_tone;
			अवरोध;
		पूर्ण

		// try the ALPS BSRU6 now
		budget->dvb_frontend = dvb_attach(stv0299_attach, &alps_bsru6_config, &budget->i2c_adap);
		अगर (budget->dvb_frontend) अणु
			budget->dvb_frontend->ops.tuner_ops.set_params = alps_bsru6_tuner_set_params;
			budget->dvb_frontend->tuner_priv = &budget->i2c_adap;

			budget->dvb_frontend->ops.diseqc_send_master_cmd = budget_diseqc_send_master_cmd;
			budget->dvb_frontend->ops.diseqc_send_burst = budget_diseqc_send_burst;
			budget->dvb_frontend->ops.set_tone = budget_set_tone;
			अवरोध;
		पूर्ण

		// Try the grundig 29504-451
		budget->dvb_frontend = dvb_attach(tda8083_attach, &grundig_29504_451_config, &budget->i2c_adap);
		अगर (budget->dvb_frontend) अणु
			budget->dvb_frontend->ops.tuner_ops.set_params = grundig_29504_451_tuner_set_params;
			budget->dvb_frontend->ops.diseqc_send_master_cmd = budget_diseqc_send_master_cmd;
			budget->dvb_frontend->ops.diseqc_send_burst = budget_diseqc_send_burst;
			budget->dvb_frontend->ops.set_tone = budget_set_tone;
			अवरोध;
		पूर्ण
		अवरोध;
	पूर्ण

	अगर (budget->dvb_frontend == शून्य) अणु
		prपूर्णांकk("dvb-ttpci: A frontend driver was not found for device [%04x:%04x] subsystem [%04x:%04x]\n",
		       budget->dev->pci->venकरोr,
		       budget->dev->pci->device,
		       budget->dev->pci->subप्रणाली_venकरोr,
		       budget->dev->pci->subप्रणाली_device);
	पूर्ण अन्यथा अणु
		अगर (dvb_रेजिस्टर_frontend(&budget->dvb_adapter, budget->dvb_frontend)) अणु
			prपूर्णांकk("budget-av: Frontend registration failed!\n");
			dvb_frontend_detach(budget->dvb_frontend);
			budget->dvb_frontend = शून्य;
		पूर्ण
	पूर्ण
पूर्ण

/* written by Emard */
अटल पूर्णांक budget_patch_attach (काष्ठा saa7146_dev* dev, काष्ठा saa7146_pci_extension_data *info)
अणु
	काष्ठा budget_patch *budget;
	पूर्णांक err;
	पूर्णांक count = 0;
	पूर्णांक detected = 0;

#घोषणा PATCH_RESET 0
#घोषणा RPS_IRQ 0
#घोषणा HPS_SETUP 0
#अगर PATCH_RESET
	saa7146_ग_लिखो(dev, MC1, MASK_31);
	msleep(40);
#पूर्ण_अगर
#अगर HPS_SETUP
	// initialize रेजिस्टरs. Better to have it like this
	// than leaving something unconfigured
	saa7146_ग_लिखो(dev, DD1_STREAM_B, 0);
	// port B VSYNC at rising edge
	saa7146_ग_लिखो(dev, DD1_INIT, 0x00000200);  // have this in budget-core too!
	saa7146_ग_लिखो(dev, BRS_CTRL, 0x00000000);  // VBI

	// debi config
	// saa7146_ग_लिखो(dev, DEBI_CONFIG, MASK_30|MASK_28|MASK_18);

	// zero all HPS रेजिस्टरs
	saa7146_ग_लिखो(dev, HPS_H_PRESCALE, 0);                  // r68
	saa7146_ग_लिखो(dev, HPS_H_SCALE, 0);                     // r6c
	saa7146_ग_लिखो(dev, BCS_CTRL, 0);                        // r70
	saa7146_ग_लिखो(dev, HPS_V_SCALE, 0);                     // r60
	saa7146_ग_लिखो(dev, HPS_V_GAIN, 0);                      // r64
	saa7146_ग_लिखो(dev, CHROMA_KEY_RANGE, 0);                // r74
	saa7146_ग_लिखो(dev, CLIP_FORMAT_CTRL, 0);                // r78
	// Set HPS prescaler क्रम port B input
	saa7146_ग_लिखो(dev, HPS_CTRL, (1<<30) | (0<<29) | (1<<28) | (0<<12) );
	saa7146_ग_लिखो(dev, MC2,
	  0 * (MASK_08 | MASK_24)  |   // BRS control
	  0 * (MASK_09 | MASK_25)  |   // a
	  0 * (MASK_10 | MASK_26)  |   // b
	  1 * (MASK_06 | MASK_22)  |   // HPS_CTRL1
	  1 * (MASK_05 | MASK_21)  |   // HPS_CTRL2
	  0 * (MASK_01 | MASK_15)      // DEBI
	   );
#पूर्ण_अगर
	// Disable RPS1 and RPS0
	saa7146_ग_लिखो(dev, MC1, ( MASK_29 | MASK_28));
	// RPS1 समयout disable
	saa7146_ग_लिखो(dev, RPS_TOV1, 0);

	// code क्रम स्वतःdetection
	// will रुको क्रम VBI_B event (vertical blank at port B)
	// and will reset GPIO3 after VBI_B is detected.
	// (GPIO3 should be उठाओd high by CPU to
	// test अगर GPIO3 will generate vertical blank संकेत
	// in budget patch GPIO3 is connected to VSYNC_B
	count = 0;
#अगर 0
	WRITE_RPS1(CMD_UPLOAD |
	  MASK_10 | MASK_09 | MASK_08 | MASK_06 | MASK_05 | MASK_04 | MASK_03 | MASK_02 );
#पूर्ण_अगर
	WRITE_RPS1(CMD_PAUSE | EVT_VBI_B);
	WRITE_RPS1(CMD_WR_REG_MASK | (GPIO_CTRL>>2));
	WRITE_RPS1(GPIO3_MSK);
	WRITE_RPS1(SAA7146_GPIO_OUTLO<<24);
#अगर RPS_IRQ
	// issue RPS1 पूर्णांकerrupt to increment counter
	WRITE_RPS1(CMD_INTERRUPT);
	// at least a NOP is neede between two पूर्णांकerrupts
	WRITE_RPS1(CMD_NOP);
	// पूर्णांकerrupt again
	WRITE_RPS1(CMD_INTERRUPT);
#पूर्ण_अगर
	WRITE_RPS1(CMD_STOP);

#अगर RPS_IRQ
	// set event counter 1 source as RPS1 पूर्णांकerrupt (0x03)          (rE4 p53)
	// use 0x03 to track RPS1 पूर्णांकerrupts - increase by 1 every gpio3 is toggled
	// use 0x15 to track VPE  पूर्णांकerrupts - increase by 1 every vpeirq() is called
	saa7146_ग_लिखो(dev, EC1SSR, (0x03<<2) | 3 );
	// set event counter 1 threshold to maximum allowed value        (rEC p55)
	saa7146_ग_लिखो(dev, ECT1R,  0x3fff );
#पूर्ण_अगर
	// Fix VSYNC level
	saa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);
	// Set RPS1 Address रेजिस्टर to poपूर्णांक to RPS code               (r108 p42)
	saa7146_ग_लिखो(dev, RPS_ADDR1, dev->d_rps1.dma_handle);
	// Enable RPS1,                                                 (rFC p33)
	saa7146_ग_लिखो(dev, MC1, (MASK_13 | MASK_29 ));


	mdelay(50);
	saa7146_setgpio(dev, 3, SAA7146_GPIO_OUTHI);
	mdelay(150);


	अगर( (saa7146_पढ़ो(dev, GPIO_CTRL) & 0x10000000) == 0)
		detected = 1;

#अगर RPS_IRQ
	prपूर्णांकk("Event Counter 1 0x%04x\n", saa7146_पढ़ो(dev, EC1R) & 0x3fff );
#पूर्ण_अगर
	// Disable RPS1
	saa7146_ग_लिखो(dev, MC1, ( MASK_29 ));

	अगर(detected == 0)
		prपूर्णांकk("budget-patch not detected or saa7146 in non-default state.\n"
		       "try enabling resetting of 7146 with MASK_31 in MC1 register\n");

	अन्यथा
		prपूर्णांकk("BUDGET-PATCH DETECTED.\n");


/*      OLD (Original design by Roberto Deza):
**      This code will setup the SAA7146_RPS1 to generate a square
**      wave on GPIO3, changing when a field (TS_HEIGHT/2 "lines" of
**      TS_WIDTH packets) has been acquired on SAA7146_D1B video port;
**      then, this GPIO3 output which is connected to the D1B_VSYNC
**      input, will trigger the acquisition of the alternate field
**      and so on.
**      Currently, the TT_budget / WinTV_Nova cards have two ICs
**      (74HCT4040, LVC74) क्रम the generation of this VSYNC संकेत,
**      which seems that can be करोne perfectly without this :-)).
*/

/*      New design (By Emard)
**      this rps1 code will copy पूर्णांकernal HS event to GPIO3 pin.
**      GPIO3 is in budget-patch hardware connected to port B VSYNC

**      HS is an पूर्णांकernal event of 7146, accessible with RPS
**      and temporarily उठाओd high every n lines
**      (n in defined in the RPS_THRESH1 counter threshold)
**      I think HS is उठाओd high on the beginning of the n-th line
**      and reमुख्यs high until this n-th line that triggered
**      it is completely received. When the reception of n-th line
**      ends, HS is lowered.

**      To transmit data over DMA, 7146 needs changing state at
**      port B VSYNC pin. Any changing of port B VSYNC will
**      cause some DMA data transfer, with more or less packets loss.
**      It depends on the phase and frequency of VSYNC and
**      the way of 7146 is inकाष्ठाed to trigger on port B (defined
**      in DD1_INIT रेजिस्टर, 3rd nibble from the right valid
**      numbers are 0-7, see datasheet)
**
**      The correct triggering can minimize packet loss,
**      dvbtraffic should give this stable bandwidths:
**        22k transponder = 33814 kbit/s
**      27.5k transponder = 38045 kbit/s
**      by experiment it is found that the best results
**      (stable bandwidths and almost no packet loss)
**      are obtained using DD1_INIT triggering number 2
**      (Va at rising edge of VS Fa = HS x VS-failing क्रमced toggle)
**      and a VSYNC phase that occurs in the middle of DMA transfer
**      (about byte 188*512=96256 in the DMA winकरोw).
**
**      Phase of HS is still not clear to me how to control,
**      It just happens to be so. It can be seen अगर one enables
**      RPS_IRQ and prपूर्णांक Event Counter 1 in vpeirq(). Every
**      समय RPS_INTERRUPT is called, the Event Counter 1 will
**      increment. That's how the 7146 is programmed to करो event
**      counting in this budget-patch.c
**      I *think* HPS setting has something to करो with the phase
**      of HS but I can't be 100% sure in that.

**      hardware debug note: a working budget card (including budget patch)
**      with vpeirq() पूर्णांकerrupt setup in mode "0x90" (every 64K) will
**      generate 3 पूर्णांकerrupts per 25-Hz DMA frame of 2*188*512 bytes
**      and that means 3*25=75 Hz of पूर्णांकerrupt frequency, as seen by
**      watch cat /proc/पूर्णांकerrupts
**
**      If this frequency is 3x lower (and data received in the DMA
**      buffer करोn't start with 0x47, but in the middle of packets,
**      whose lengths appear to be like 188 292 188 104 etc.
**      this means VSYNC line is not connected in the hardware.
**      (check soldering pcb and pins)
**      The same behaviour of missing VSYNC can be duplicated on budget
**      cards, by setting DD1_INIT trigger mode 7 in 3rd nibble.
*/

	// Setup RPS1 "program" (p35)
	count = 0;


	// Wait Source Line Counter Threshold                           (p36)
	WRITE_RPS1(CMD_PAUSE | EVT_HS);
	// Set GPIO3=1                                                  (p42)
	WRITE_RPS1(CMD_WR_REG_MASK | (GPIO_CTRL>>2));
	WRITE_RPS1(GPIO3_MSK);
	WRITE_RPS1(SAA7146_GPIO_OUTHI<<24);
#अगर RPS_IRQ
	// issue RPS1 पूर्णांकerrupt
	WRITE_RPS1(CMD_INTERRUPT);
#पूर्ण_अगर
	// Wait reset Source Line Counter Threshold                     (p36)
	WRITE_RPS1(CMD_PAUSE | RPS_INV | EVT_HS);
	// Set GPIO3=0                                                  (p42)
	WRITE_RPS1(CMD_WR_REG_MASK | (GPIO_CTRL>>2));
	WRITE_RPS1(GPIO3_MSK);
	WRITE_RPS1(SAA7146_GPIO_OUTLO<<24);
#अगर RPS_IRQ
	// issue RPS1 पूर्णांकerrupt
	WRITE_RPS1(CMD_INTERRUPT);
#पूर्ण_अगर
	// Jump to begin of RPS program                                 (p37)
	WRITE_RPS1(CMD_JUMP);
	WRITE_RPS1(dev->d_rps1.dma_handle);

	// Fix VSYNC level
	saa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);
	// Set RPS1 Address रेजिस्टर to poपूर्णांक to RPS code               (r108 p42)
	saa7146_ग_लिखो(dev, RPS_ADDR1, dev->d_rps1.dma_handle);

	अगर (!(budget = kदो_स्मृति (माप(काष्ठा budget_patch), GFP_KERNEL)))
		वापस -ENOMEM;

	dprपूर्णांकk(2, "budget: %p\n", budget);

	err = ttpci_budget_init(budget, dev, info, THIS_MODULE, adapter_nr);
	अगर (err) अणु
		kमुक्त(budget);
		वापस err;
	पूर्ण

	// Set Source Line Counter Threshold, using BRS                 (rCC p43)
	// It generates HS event every TS_HEIGHT lines
	// this is related to TS_WIDTH set in रेजिस्टर
	// NUM_LINE_BYTE3 in budget-core.c. If NUM_LINE_BYTE
	// low 16 bits are set to TS_WIDTH bytes (TS_WIDTH=2*188
	//,then RPS_THRESH1
	// should be set to trigger every TS_HEIGHT (512) lines.
	//
	saa7146_ग_लिखो(dev, RPS_THRESH1, budget->buffer_height | MASK_12 );

	// saa7146_ग_लिखो(dev, RPS_THRESH0, ((TS_HEIGHT/2)<<16) |MASK_28| (TS_HEIGHT/2) |MASK_12 );
	// Enable RPS1                                                  (rFC p33)
	saa7146_ग_लिखो(dev, MC1, (MASK_13 | MASK_29));


	dev->ext_priv = budget;

	budget->dvb_adapter.priv = budget;
	frontend_init(budget);

	ttpci_budget_init_hooks(budget);

	वापस 0;
पूर्ण

अटल पूर्णांक budget_patch_detach (काष्ठा saa7146_dev* dev)
अणु
	काष्ठा budget_patch *budget = (काष्ठा budget_patch*) dev->ext_priv;
	पूर्णांक err;

	अगर (budget->dvb_frontend) अणु
		dvb_unरेजिस्टर_frontend(budget->dvb_frontend);
		dvb_frontend_detach(budget->dvb_frontend);
	पूर्ण
	err = ttpci_budget_deinit (budget);

	kमुक्त (budget);

	वापस err;
पूर्ण

अटल पूर्णांक __init budget_patch_init(व्योम)
अणु
	वापस saa7146_रेजिस्टर_extension(&budget_extension);
पूर्ण

अटल व्योम __निकास budget_patch_निकास(व्योम)
अणु
	saa7146_unरेजिस्टर_extension(&budget_extension);
पूर्ण

अटल काष्ठा saa7146_extension budget_extension = अणु
	.name           = "budget_patch dvb",
	.flags          = 0,

	.module         = THIS_MODULE,
	.pci_tbl        = pci_tbl,
	.attach         = budget_patch_attach,
	.detach         = budget_patch_detach,

	.irq_mask       = MASK_10,
	.irq_func       = ttpci_budget_irq10_handler,
पूर्ण;

module_init(budget_patch_init);
module_निकास(budget_patch_निकास);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Emard, Roberto Deza, Holger Waechtler, Michael Hunold, others");
MODULE_DESCRIPTION("Driver for full TS modified DVB-S SAA7146+AV7110 based so-called Budget Patch cards");
