<शैली गुरु>
// SPDX-License-Identअगरier: GPL-2.0+
/*
 * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.
 * All rights reserved.
 *
 * File: baseband.c
 *
 * Purpose: Implement functions to access baseband
 *
 * Author: Jerry Chen
 *
 * Date: Jun. 5, 2002
 *
 * Functions:
 *	vnt_get_frame_समय	- Calculate data frame transmitting समय
 *	vnt_get_phy_field	- Calculate PhyLength, PhyService and Phy
 *				  Signal parameter क्रम baseband Tx
 *	vnt_vt3184_init		- VIA VT3184 baseband chip init code
 *
 * Revision History:
 *
 *
 */

#समावेश <linux/bits.h>
#समावेश <linux/त्रुटिसं.स>
#समावेश <linux/kernel.h>
#समावेश "device.h"
#समावेश "mac.h"
#समावेश "baseband.h"
#समावेश "rf.h"
#समावेश "usbpipe.h"

अटल स्थिर u8 vnt_vt3184_agc[] = अणु
	0x00, 0x00, 0x02, 0x02, 0x04, 0x04, 0x06, 0x06,
	0x08, 0x08, 0x0a, 0x0a, 0x0c, 0x0c, 0x0e, 0x0e, /* 0x0f */
	0x10, 0x10, 0x12, 0x12, 0x14, 0x14, 0x16, 0x16,
	0x18, 0x18, 0x1a, 0x1a, 0x1c, 0x1c, 0x1e, 0x1e, /* 0x1f */
	0x20, 0x20, 0x22, 0x22, 0x24, 0x24, 0x26, 0x26,
	0x28, 0x28, 0x2a, 0x2a, 0x2c, 0x2c, 0x2e, 0x2e, /* 0x2f */
	0x30, 0x30, 0x32, 0x32, 0x34, 0x34, 0x36, 0x36,
	0x38, 0x38, 0x3a, 0x3a, 0x3c, 0x3c, 0x3e, 0x3e  /* 0x3f */
पूर्ण;

अटल u8 vnt_vt3184_al2230[] = अणु
	0x31, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00,
	0x70, 0x45, 0x2a, 0x76, 0x00, 0x00, 0x80, 0x00, /* 0x0f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x8e, 0x0a, 0x00, 0x00, 0x00, /* 0x1f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x4a, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x4a, 0x00, 0x0c, /* 0x2f */
	0x26, 0x5b, 0x00, 0x00, 0x00, 0x00, 0xaa, 0xaa,
	0xff, 0xff, 0x79, 0x00, 0x00, 0x0b, 0x48, 0x04, /* 0x3f */
	0x00, 0x08, 0x00, 0x08, 0x08, 0x14, 0x05, 0x09,
	0x00, 0x00, 0x00, 0x00, 0x09, 0x73, 0x00, 0xc5, /* 0x4f */
	0x00, 0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x5f */
	0xe4, 0x80, 0x00, 0x00, 0x00, 0x00, 0x98, 0x0a,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x01, 0x00, /* 0x6f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x7f */
	0x8c, 0x01, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x08, 0x00, 0x1f, 0xb7, 0x88, 0x47, 0xaa, 0x00, /* 0x8f */
	0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xeb,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, /* 0x9f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,
	0x18, 0x00, 0x00, 0x00, 0x00, 0x15, 0x00, 0x18, /* 0xaf */
	0x38, 0x30, 0x00, 0x00, 0xff, 0x0f, 0xe4, 0xe2,
	0x00, 0x00, 0x00, 0x03, 0x01, 0x00, 0x00, 0x00, /* 0xbf */
	0x18, 0x20, 0x07, 0x18, 0xff, 0xff, 0x0e, 0x0a,
	0x0e, 0x00, 0x82, 0xa7, 0x3c, 0x10, 0x30, 0x05, /* 0xcf */
	0x40, 0x12, 0x00, 0x00, 0x10, 0x28, 0x80, 0x2a,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xdf */
	0x00, 0xf3, 0x00, 0x00, 0x00, 0x10, 0x00, 0x12,
	0x00, 0xf4, 0x00, 0xff, 0x79, 0x20, 0x30, 0x05, /* 0xef */
	0x00, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  /* 0xff */
पूर्ण;

/* अणुअणुRobertYu:20060515, new BB setting क्रम VT3226D0 */
अटल स्थिर u8 vnt_vt3184_vt3226d0[] = अणु
	0x31, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00,
	0x70, 0x45, 0x2a, 0x76, 0x00, 0x00, 0x80, 0x00, /* 0x0f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x8e, 0x0a, 0x00, 0x00, 0x00, /* 0x1f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x4a, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x4a, 0x00, 0x0c, /* 0x2f */
	0x26, 0x5b, 0x00, 0x00, 0x00, 0x00, 0xaa, 0xaa,
	0xff, 0xff, 0x79, 0x00, 0x00, 0x0b, 0x48, 0x04, /* 0x3f */
	0x00, 0x08, 0x00, 0x08, 0x08, 0x14, 0x05, 0x09,
	0x00, 0x00, 0x00, 0x00, 0x09, 0x73, 0x00, 0xc5, /* 0x4f */
	0x00, 0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x5f */
	0xe4, 0x80, 0x00, 0x00, 0x00, 0x00, 0x98, 0x0a,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x01, 0x00, /* 0x6f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x7f */
	0x8c, 0x01, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x08, 0x00, 0x1f, 0xb7, 0x88, 0x47, 0xaa, 0x00, /* 0x8f */
	0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xeb,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, /* 0x9f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,
	0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, /* 0xaf */
	0x38, 0x30, 0x00, 0x00, 0xff, 0x0f, 0xe4, 0xe2,
	0x00, 0x00, 0x00, 0x03, 0x01, 0x00, 0x00, 0x00, /* 0xbf */
	0x18, 0x20, 0x07, 0x18, 0xff, 0xff, 0x10, 0x0a,
	0x0e, 0x00, 0x84, 0xa7, 0x3c, 0x10, 0x24, 0x05, /* 0xcf */
	0x40, 0x12, 0x00, 0x00, 0x10, 0x28, 0x80, 0x2a,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xdf */
	0x00, 0xf3, 0x00, 0x00, 0x00, 0x10, 0x00, 0x10,
	0x00, 0xf4, 0x00, 0xff, 0x79, 0x20, 0x30, 0x08, /* 0xef */
	0x00, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  /* 0xff */
पूर्ण;

काष्ठा vnt_threshold अणु
	u8 bb_pre_ed_rssi;
	u8 cr_201;
	u8 cr_206;
पूर्ण;

अटल स्थिर काष्ठा vnt_threshold al2230_vnt_threshold[] = अणु
	अणु0, 0x00, 0x30पूर्ण,	/* Max sensitivity */
	अणु68, 0x00, 0x36पूर्ण,
	अणु67, 0x00, 0x43पूर्ण,
	अणु66, 0x00, 0x51पूर्ण,
	अणु65, 0x00, 0x62पूर्ण,
	अणु64, 0x00, 0x79पूर्ण,
	अणु63, 0x00, 0x93पूर्ण,
	अणु62, 0x00, 0xb9पूर्ण,
	अणु61, 0x00, 0xe3पूर्ण,
	अणु60, 0x01, 0x18पूर्ण,
	अणु59, 0x01, 0x54पूर्ण,
	अणु58, 0x01, 0xa0पूर्ण,
	अणु57, 0x02, 0x20पूर्ण,
	अणु56, 0x02, 0xa0पूर्ण,
	अणु55, 0x03, 0x00पूर्ण,
	अणु53, 0x06, 0x00पूर्ण,
	अणु51, 0x09, 0x00पूर्ण,
	अणु49, 0x0e, 0x00पूर्ण,
	अणु47, 0x15, 0x00पूर्ण,
	अणु46, 0x1a, 0x00पूर्ण,
	अणु45, 0xff, 0x00पूर्ण
पूर्ण;

अटल स्थिर काष्ठा vnt_threshold vt3226_vnt_threshold[] = अणु
	अणु0, 0x00, 0x24पूर्ण,	/* Max sensitivity */
	अणु68, 0x00, 0x2dपूर्ण,
	अणु67, 0x00, 0x36पूर्ण,
	अणु66, 0x00, 0x43पूर्ण,
	अणु65, 0x00, 0x52पूर्ण,
	अणु64, 0x00, 0x68पूर्ण,
	अणु63, 0x00, 0x80पूर्ण,
	अणु62, 0x00, 0x9cपूर्ण,
	अणु61, 0x00, 0xc0पूर्ण,
	अणु60, 0x00, 0xeaपूर्ण,
	अणु59, 0x01, 0x30पूर्ण,
	अणु58, 0x01, 0x70पूर्ण,
	अणु57, 0x01, 0xb0पूर्ण,
	अणु56, 0x02, 0x30पूर्ण,
	अणु55, 0x02, 0xc0पूर्ण,
	अणु53, 0x04, 0x00पूर्ण,
	अणु51, 0x07, 0x00पूर्ण,
	अणु49, 0x0a, 0x00पूर्ण,
	अणु47, 0x11, 0x00पूर्ण,
	अणु45, 0x18, 0x00पूर्ण,
	अणु43, 0x26, 0x00पूर्ण,
	अणु42, 0x36, 0x00पूर्ण,
	अणु41, 0xff, 0x00पूर्ण
पूर्ण;

अटल स्थिर काष्ठा vnt_threshold vt3342_vnt_threshold[] = अणु
	अणु0, 0x00, 0x38पूर्ण,	/* Max sensitivity */
	अणु66, 0x00, 0x43पूर्ण,
	अणु65, 0x00, 0x52पूर्ण,
	अणु64, 0x00, 0x68पूर्ण,
	अणु63, 0x00, 0x80पूर्ण,
	अणु62, 0x00, 0x9cपूर्ण,
	अणु61, 0x00, 0xc0पूर्ण,
	अणु60, 0x00, 0xeaपूर्ण,
	अणु59, 0x01, 0x30पूर्ण,
	अणु58, 0x01, 0x70पूर्ण,
	अणु57, 0x01, 0xb0पूर्ण,
	अणु56, 0x02, 0x30पूर्ण,
	अणु55, 0x02, 0xc0पूर्ण,
	अणु53, 0x04, 0x00पूर्ण,
	अणु51, 0x07, 0x00पूर्ण,
	अणु49, 0x0a, 0x00पूर्ण,
	अणु47, 0x11, 0x00पूर्ण,
	अणु45, 0x18, 0x00पूर्ण,
	अणु43, 0x26, 0x00पूर्ण,
	अणु42, 0x36, 0x00पूर्ण,
	अणु41, 0xff, 0x00पूर्ण
पूर्ण;

/*
 * Description: Set Antenna mode
 *
 * Parameters:
 *  In:
 *	priv		- Device Structure
 *	antenna_mode	- Antenna Mode
 *  Out:
 *      none
 *
 * Return Value: none
 *
 */
पूर्णांक vnt_set_antenna_mode(काष्ठा vnt_निजी *priv, u8 antenna_mode)
अणु
	चयन (antenna_mode) अणु
	हाल ANT_TXA:
	हाल ANT_TXB:
		अवरोध;
	हाल ANT_RXA:
		priv->bb_rx_conf &= 0xFC;
		अवरोध;
	हाल ANT_RXB:
		priv->bb_rx_conf &= 0xFE;
		priv->bb_rx_conf |= 0x02;
		अवरोध;
	पूर्ण

	वापस vnt_control_out(priv, MESSAGE_TYPE_SET_ANTMD,
			       (u16)antenna_mode, 0, 0, शून्य);
पूर्ण

/*
 * Description: Set Antenna mode
 *
 * Parameters:
 *  In:
 *      pDevice          - Device Structure
 *      byAntennaMode    - Antenna Mode
 *  Out:
 *      none
 *
 * Return Value: none
 *
 */

पूर्णांक vnt_vt3184_init(काष्ठा vnt_निजी *priv)
अणु
	पूर्णांक ret;
	u16 length;
	u8 *addr = शून्य;
	स्थिर u8 *c_addr;
	u8 data;

	ret = vnt_control_in(priv, MESSAGE_TYPE_READ, 0, MESSAGE_REQUEST_EEPROM,
			     EEP_MAX_CONTEXT_SIZE, priv->eeprom);
	अगर (ret)
		जाओ end;

	priv->rf_type = priv->eeprom[EEP_OFS_RFTYPE];

	dev_dbg(&priv->usb->dev, "RF Type %d\n", priv->rf_type);

	अगर ((priv->rf_type == RF_AL2230) ||
	    (priv->rf_type == RF_AL2230S) ||
	    (priv->rf_type == RF_AIROHA7230)) अणु
		priv->bb_rx_conf = vnt_vt3184_al2230[10];
		length = माप(vnt_vt3184_al2230);
		addr = vnt_vt3184_al2230;

		अगर (priv->rf_type == RF_AIROHA7230)
			addr[0xd7] = 0x06;

		priv->bb_vga[0] = 0x1c;
		priv->bb_vga[1] = 0x10;
		priv->bb_vga[2] = 0x0;
		priv->bb_vga[3] = 0x0;

	पूर्ण अन्यथा अगर ((priv->rf_type == RF_VT3226) ||
		   (priv->rf_type == RF_VT3226D0) ||
		   (priv->rf_type == RF_VT3342A0)) अणु
		priv->bb_rx_conf = vnt_vt3184_vt3226d0[10];
		length = माप(vnt_vt3184_vt3226d0);
		c_addr = vnt_vt3184_vt3226d0;

		priv->bb_vga[0] = 0x20;
		priv->bb_vga[1] = 0x10;
		priv->bb_vga[2] = 0x0;
		priv->bb_vga[3] = 0x0;

		/* Fix VT3226 DFC प्रणाली timing issue */
		ret = vnt_mac_reg_bits_on(priv, MAC_REG_SOFTPWRCTL2,
					  SOFTPWRCTL_RFLEOPT);
		अगर (ret)
			जाओ end;
	पूर्ण अन्यथा अणु
		जाओ end;
	पूर्ण

	अगर (addr)
		c_addr = addr;

	ret = vnt_control_out_blocks(priv, VNT_REG_BLOCK_SIZE,
				     MESSAGE_REQUEST_BBREG, length, c_addr);
	अगर (ret)
		जाओ end;

	ret = vnt_control_out(priv, MESSAGE_TYPE_WRITE, 0,
			      MESSAGE_REQUEST_BBAGC,
			      माप(vnt_vt3184_agc), vnt_vt3184_agc);
	अगर (ret)
		जाओ end;

	अगर ((priv->rf_type == RF_VT3226) ||
	    (priv->rf_type == RF_VT3342A0) ||
	    (priv->rf_type == RF_VT3226D0)) अणु
		data = (priv->rf_type == RF_VT3226D0) ? 0x11 : 0x23;

		ret = vnt_control_out_u8(priv, MESSAGE_REQUEST_MACREG,
					 MAC_REG_ITRTMSET, data);
		अगर (ret)
			जाओ end;

		ret = vnt_mac_reg_bits_on(priv, MAC_REG_PAPEDELAY, BIT(0));
		अगर (ret)
			जाओ end;
	पूर्ण

	ret = vnt_control_out_u8(priv, MESSAGE_REQUEST_BBREG, 0x04, 0x7f);
	अगर (ret)
		जाओ end;

	ret = vnt_control_out_u8(priv, MESSAGE_REQUEST_BBREG, 0x0d, 0x01);
	अगर (ret)
		जाओ end;

	ret = vnt_rf_table_करोwnload(priv);
	अगर (ret)
		जाओ end;

	/* Fix क्रम TX USB resets from venकरोrs driver */
	ret = vnt_control_in(priv, MESSAGE_TYPE_READ, USB_REG4,
			     MESSAGE_REQUEST_MEM, माप(data), &data);
	अगर (ret)
		जाओ end;

	data |= 0x2;

	ret = vnt_control_out(priv, MESSAGE_TYPE_WRITE, USB_REG4,
			      MESSAGE_REQUEST_MEM, माप(data), &data);

end:
	वापस ret;
पूर्ण

/*
 * Description: Set ShortSlotTime mode
 *
 * Parameters:
 *  In:
 *	priv	- Device Structure
 *  Out:
 *      none
 *
 * Return Value: none
 *
 */
पूर्णांक vnt_set_लघु_slot_समय(काष्ठा vnt_निजी *priv)
अणु
	पूर्णांक ret = 0;
	u8 bb_vga = 0;

	अगर (priv->लघु_slot_समय)
		priv->bb_rx_conf &= 0xdf;
	अन्यथा
		priv->bb_rx_conf |= 0x20;

	ret = vnt_control_in_u8(priv, MESSAGE_REQUEST_BBREG, 0xe7, &bb_vga);
	अगर (ret)
		वापस ret;

	अगर (bb_vga == priv->bb_vga[0])
		priv->bb_rx_conf |= 0x20;

	वापस vnt_control_out_u8(priv, MESSAGE_REQUEST_BBREG, 0x0a,
				  priv->bb_rx_conf);
पूर्ण

पूर्णांक vnt_set_vga_gain_offset(काष्ठा vnt_निजी *priv, u8 data)
अणु
	पूर्णांक ret;

	ret = vnt_control_out_u8(priv, MESSAGE_REQUEST_BBREG, 0xE7, data);
	अगर (ret)
		वापस ret;

	/* patch क्रम 3253B0 Baseband with Cardbus module */
	अगर (priv->लघु_slot_समय)
		priv->bb_rx_conf &= 0xdf; /* 1101 1111 */
	अन्यथा
		priv->bb_rx_conf |= 0x20; /* 0010 0000 */

	वापस vnt_control_out_u8(priv, MESSAGE_REQUEST_BBREG, 0x0a,
				  priv->bb_rx_conf);
पूर्ण

/*
 * Description: vnt_set_deep_sleep
 *
 * Parameters:
 *  In:
 *	priv	- Device Structure
 *  Out:
 *      none
 *
 * Return Value: none
 *
 */
पूर्णांक vnt_set_deep_sleep(काष्ठा vnt_निजी *priv)
अणु
	पूर्णांक ret = 0;

	/* CR12 */
	ret = vnt_control_out_u8(priv, MESSAGE_REQUEST_BBREG, 0x0c, 0x17);
	अगर (ret)
		वापस ret;

	/* CR13 */
	वापस vnt_control_out_u8(priv, MESSAGE_REQUEST_BBREG, 0x0d, 0xB9);
पूर्ण

पूर्णांक vnt_निकास_deep_sleep(काष्ठा vnt_निजी *priv)
अणु
	पूर्णांक ret = 0;

	/* CR12 */
	ret = vnt_control_out_u8(priv, MESSAGE_REQUEST_BBREG, 0x0c, 0x00);
	अगर (ret)
		वापस ret;

	/* CR13 */
	वापस vnt_control_out_u8(priv, MESSAGE_REQUEST_BBREG, 0x0d, 0x01);
पूर्ण

पूर्णांक vnt_update_pre_ed_threshold(काष्ठा vnt_निजी *priv, पूर्णांक scanning)
अणु
	स्थिर काष्ठा vnt_threshold *threshold = शून्य;
	u8 length;
	u8 cr_201, cr_206;
	u8 ed_inx;
	पूर्णांक ret;

	चयन (priv->rf_type) अणु
	हाल RF_AL2230:
	हाल RF_AL2230S:
	हाल RF_AIROHA7230:
		threshold = al2230_vnt_threshold;
		length = ARRAY_SIZE(al2230_vnt_threshold);
		अवरोध;

	हाल RF_VT3226:
	हाल RF_VT3226D0:
		threshold = vt3226_vnt_threshold;
		length = ARRAY_SIZE(vt3226_vnt_threshold);
		अवरोध;

	हाल RF_VT3342A0:
		threshold = vt3342_vnt_threshold;
		length = ARRAY_SIZE(vt3342_vnt_threshold);
		अवरोध;
	पूर्ण

	अगर (!threshold)
		वापस -EINVAL;

	क्रम (ed_inx = scanning ? 0 : length - 1; ed_inx > 0; ed_inx--) अणु
		अगर (priv->bb_pre_ed_rssi <= threshold[ed_inx].bb_pre_ed_rssi)
			अवरोध;
	पूर्ण

	cr_201 = threshold[ed_inx].cr_201;
	cr_206 = threshold[ed_inx].cr_206;

	अगर (ed_inx == priv->bb_pre_ed_index && !scanning)
		वापस 0;

	priv->bb_pre_ed_index = ed_inx;

	dev_dbg(&priv->usb->dev, "%s bb_pre_ed_rssi %d\n",
		__func__, priv->bb_pre_ed_rssi);

	ret = vnt_control_out_u8(priv, MESSAGE_REQUEST_BBREG, 0xc9, cr_201);
	अगर (ret)
		वापस ret;

	वापस vnt_control_out_u8(priv, MESSAGE_REQUEST_BBREG, 0xce, cr_206);
पूर्ण

