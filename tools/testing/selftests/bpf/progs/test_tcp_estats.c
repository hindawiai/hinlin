<शैली गुरु>
/* Copyright (c) 2017 Facebook
 *
 * This program is मुक्त software; you can redistribute it and/or
 * modअगरy it under the terms of version 2 of the GNU General Public
 * License as published by the Free Software Foundation.
 */

/* This program shows clang/llvm is able to generate code pattern
 * like:
 *   _tcp_send_active_reset:
 *      0:       bf 16 00 00 00 00 00 00         r6 = r1
 *    ......
 *    335:       b7 01 00 00 0f 00 00 00         r1 = 15
 *    336:       05 00 48 00 00 00 00 00         जाओ 72
 *
 *   LBB0_3:
 *    337:       b7 01 00 00 01 00 00 00         r1 = 1
 *    338:       63 1a d0 ff 00 00 00 00         *(u32 *)(r10 - 48) = r1
 *    408:       b7 01 00 00 03 00 00 00         r1 = 3
 *
 *   LBB0_4:
 *    409:       71 a2 fe ff 00 00 00 00         r2 = *(u8 *)(r10 - 2)
 *    410:       bf a7 00 00 00 00 00 00         r7 = r10
 *    411:       07 07 00 00 b8 ff ff ff         r7 += -72
 *    412:       bf 73 00 00 00 00 00 00         r3 = r7
 *    413:       0f 13 00 00 00 00 00 00         r3 += r1
 *    414:       73 23 2d 00 00 00 00 00         *(u8 *)(r3 + 45) = r2
 *
 * From the above code snippet, the code generated by the compiler
 * is reasonable. The "r1" is asचिन्हित to dअगरferent values in basic
 * blocks "_tcp_send_active_reset" and "LBB0_3", and used in "LBB0_4".
 * The verअगरier should be able to handle such code patterns.
 */
#समावेश <माला.स>
#समावेश <linux/bpf.h>
#समावेश <linux/ipv6.h>
#समावेश <linux/version.h>
#समावेश <sys/socket.h>
#समावेश <bpf/bpf_helpers.h>

#घोषणा _(P) (अणुtypeof(P) val = 0; bpf_probe_पढ़ो_kernel(&val, माप(val), &P); val;पूर्ण)
#घोषणा TCP_ESTATS_MAGIC 0xBAADBEEF

/* This test हाल needs "sock" and "pt_regs" data काष्ठाure.
 * Recursively, "sock" needs "sock_common" and "inet_sock".
 * However, this is a unit test हाल only क्रम
 * verअगरier purpose without bpf program execution.
 * We can safely mock much simpler data काष्ठाures, basically
 * only taking the necessary fields from kernel headers.
 */
प्रकार __u32 __bitwise __portpair;
प्रकार __u64 __bitwise __addrpair;

काष्ठा sock_common अणु
	अचिन्हित लघु		skc_family;
	जोड़ अणु
		__addrpair	skc_addrpair;
		काष्ठा अणु
			__be32	skc_daddr;
			__be32	skc_rcv_saddr;
		पूर्ण;
	पूर्ण;
	जोड़ अणु
		__portpair	skc_portpair;
		काष्ठा अणु
			__be16	skc_dport;
			__u16	skc_num;
		पूर्ण;
	पूर्ण;
	काष्ठा in6_addr		skc_v6_daddr;
	काष्ठा in6_addr		skc_v6_rcv_saddr;
पूर्ण;

काष्ठा sock अणु
	काष्ठा sock_common	__sk_common;
#घोषणा sk_family		__sk_common.skc_family
#घोषणा sk_v6_daddr		__sk_common.skc_v6_daddr
#घोषणा sk_v6_rcv_saddr		__sk_common.skc_v6_rcv_saddr
पूर्ण;

काष्ठा inet_sock अणु
	काष्ठा sock		sk;
#घोषणा inet_daddr		sk.__sk_common.skc_daddr
#घोषणा inet_dport		sk.__sk_common.skc_dport
	__be32			inet_saddr;
	__be16			inet_sport;
पूर्ण;

काष्ठा pt_regs अणु
	दीर्घ di;
पूर्ण;

अटल अंतरभूत काष्ठा inet_sock *inet_sk(स्थिर काष्ठा sock *sk)
अणु
	वापस (काष्ठा inet_sock *)sk;
पूर्ण

/* Define various data काष्ठाures क्रम state recording.
 * Some fields are not used due to test simplअगरication.
 */
क्रमागत tcp_estats_addrtype अणु
	TCP_ESTATS_ADDRTYPE_IPV4 = 1,
	TCP_ESTATS_ADDRTYPE_IPV6 = 2
पूर्ण;

क्रमागत tcp_estats_event_type अणु
	TCP_ESTATS_ESTABLISH,
	TCP_ESTATS_PERIODIC,
	TCP_ESTATS_TIMEOUT,
	TCP_ESTATS_RETRANSMIT_TIMEOUT,
	TCP_ESTATS_RETRANSMIT_OTHER,
	TCP_ESTATS_SYN_RETRANSMIT,
	TCP_ESTATS_SYNACK_RETRANSMIT,
	TCP_ESTATS_TERM,
	TCP_ESTATS_TX_RESET,
	TCP_ESTATS_RX_RESET,
	TCP_ESTATS_WRITE_TIMEOUT,
	TCP_ESTATS_CONN_TIMEOUT,
	TCP_ESTATS_ACK_LATENCY,
	TCP_ESTATS_NEVENTS,
पूर्ण;

काष्ठा tcp_estats_event अणु
	पूर्णांक pid;
	पूर्णांक cpu;
	अचिन्हित दीर्घ ts;
	अचिन्हित पूर्णांक magic;
	क्रमागत tcp_estats_event_type event_type;
पूर्ण;

/* The below data काष्ठाure is packed in order क्रम
 * llvm compiler to generate expected code.
 */
काष्ठा tcp_estats_conn_id अणु
	अचिन्हित पूर्णांक localaddressType;
	काष्ठा अणु
		अचिन्हित अक्षर data[16];
	पूर्ण localaddress;
	काष्ठा अणु
		अचिन्हित अक्षर data[16];
	पूर्ण remaddress;
	अचिन्हित लघु    localport;
	अचिन्हित लघु    remport;
पूर्ण __attribute__((__packed__));

काष्ठा tcp_estats_basic_event अणु
	काष्ठा tcp_estats_event event;
	काष्ठा tcp_estats_conn_id conn_id;
पूर्ण;

काष्ठा अणु
	__uपूर्णांक(type, BPF_MAP_TYPE_HASH);
	__uपूर्णांक(max_entries, 1024);
	__type(key, __u32);
	__type(value, काष्ठा tcp_estats_basic_event);
पूर्ण ev_record_map SEC(".maps");

काष्ठा dummy_tracepoपूर्णांक_args अणु
	अचिन्हित दीर्घ दीर्घ pad;
	काष्ठा sock *sock;
पूर्ण;

अटल __always_अंतरभूत व्योम tcp_estats_ev_init(काष्ठा tcp_estats_event *event,
					       क्रमागत tcp_estats_event_type type)
अणु
	event->magic = TCP_ESTATS_MAGIC;
	event->ts = bpf_kसमय_get_ns();
	event->event_type = type;
पूर्ण

अटल __always_अंतरभूत व्योम unaligned_u32_set(अचिन्हित अक्षर *to, __u8 *from)
अणु
	to[0] = _(from[0]);
	to[1] = _(from[1]);
	to[2] = _(from[2]);
	to[3] = _(from[3]);
पूर्ण

अटल __always_अंतरभूत व्योम conn_id_ipv4_init(काष्ठा tcp_estats_conn_id *conn_id,
					      __be32 *saddr, __be32 *daddr)
अणु
	conn_id->localaddressType = TCP_ESTATS_ADDRTYPE_IPV4;

	unaligned_u32_set(conn_id->localaddress.data, (__u8 *)saddr);
	unaligned_u32_set(conn_id->remaddress.data, (__u8 *)daddr);
पूर्ण

अटल __always_अंतरभूत व्योम conn_id_ipv6_init(काष्ठा tcp_estats_conn_id *conn_id,
					      __be32 *saddr, __be32 *daddr)
अणु
	conn_id->localaddressType = TCP_ESTATS_ADDRTYPE_IPV6;

	unaligned_u32_set(conn_id->localaddress.data, (__u8 *)saddr);
	unaligned_u32_set(conn_id->localaddress.data + माप(__u32),
			  (__u8 *)(saddr + 1));
	unaligned_u32_set(conn_id->localaddress.data + माप(__u32) * 2,
			  (__u8 *)(saddr + 2));
	unaligned_u32_set(conn_id->localaddress.data + माप(__u32) * 3,
			  (__u8 *)(saddr + 3));

	unaligned_u32_set(conn_id->remaddress.data,
			  (__u8 *)(daddr));
	unaligned_u32_set(conn_id->remaddress.data + माप(__u32),
			  (__u8 *)(daddr + 1));
	unaligned_u32_set(conn_id->remaddress.data + माप(__u32) * 2,
			  (__u8 *)(daddr + 2));
	unaligned_u32_set(conn_id->remaddress.data + माप(__u32) * 3,
			  (__u8 *)(daddr + 3));
पूर्ण

अटल __always_अंतरभूत व्योम tcp_estats_conn_id_init(काष्ठा tcp_estats_conn_id *conn_id,
						    काष्ठा sock *sk)
अणु
	conn_id->localport = _(inet_sk(sk)->inet_sport);
	conn_id->remport = _(inet_sk(sk)->inet_dport);

	अगर (_(sk->sk_family) == AF_INET6)
		conn_id_ipv6_init(conn_id,
				  sk->sk_v6_rcv_saddr.s6_addr32,
				  sk->sk_v6_daddr.s6_addr32);
	अन्यथा
		conn_id_ipv4_init(conn_id,
				  &inet_sk(sk)->inet_saddr,
				  &inet_sk(sk)->inet_daddr);
पूर्ण

अटल __always_अंतरभूत व्योम tcp_estats_init(काष्ठा sock *sk,
					    काष्ठा tcp_estats_event *event,
					    काष्ठा tcp_estats_conn_id *conn_id,
					    क्रमागत tcp_estats_event_type type)
अणु
	tcp_estats_ev_init(event, type);
	tcp_estats_conn_id_init(conn_id, sk);
पूर्ण

अटल __always_अंतरभूत व्योम send_basic_event(काष्ठा sock *sk,
					     क्रमागत tcp_estats_event_type type)
अणु
	काष्ठा tcp_estats_basic_event ev;
	__u32 key = bpf_get_pअक्रमom_u32();

	स_रखो(&ev, 0, माप(ev));
	tcp_estats_init(sk, &ev.event, &ev.conn_id, type);
	bpf_map_update_elem(&ev_record_map, &key, &ev, BPF_ANY);
पूर्ण

SEC("dummy_tracepoint")
पूर्णांक _dummy_tracepoपूर्णांक(काष्ठा dummy_tracepoपूर्णांक_args *arg)
अणु
	अगर (!arg->sock)
		वापस 0;

	send_basic_event(arg->sock, TCP_ESTATS_TX_RESET);
	वापस 0;
पूर्ण

अक्षर _license[] SEC("license") = "GPL";
__u32 _version SEC("version") = 1; /* ignored by tracepoपूर्णांकs, required by libbpf.a */
