<शैली गुरु>
// SPDX-License-Identअगरier: GPL-2.0-only
/*
 * Copyright (C) 2004, 2007-2010, 2011-2012 Synopsys, Inc. (www.synopsys.com)
 *
 * Vineetg: Aug 2009
 *  -"C" version of lowest level context चयन यंत्र macro called by schedular
 *   gcc करोesn't generate the dward CFI info for hand written asm, hence can't
 *   backtrace out of it (e.g. tasks sleeping in kernel).
 *   So we cheat a bit by writing almost similar code in अंतरभूत-यंत्र.
 *  -This is a hacky way of करोing things, but there is no other simple way.
 *   I करोn't want/पूर्णांकend to extend unwinding code to understand raw यंत्र
 */

#समावेश <यंत्र/यंत्र-offsets.h>
#समावेश <linux/sched.h>
#समावेश <linux/sched/debug.h>

#घोषणा KSP_WORD_OFF 	((TASK_THREAD + THREAD_KSP) / 4)

काष्ठा task_काष्ठा *__sched
__चयन_to(काष्ठा task_काष्ठा *prev_task, काष्ठा task_काष्ठा *next_task)
अणु
	अचिन्हित पूर्णांक पंचांगp;
	अचिन्हित पूर्णांक prev = (अचिन्हित पूर्णांक)prev_task;
	अचिन्हित पूर्णांक next = (अचिन्हित पूर्णांक)next_task;

	__यंत्र__ __अस्थिर__(
		/* FP/BLINK save generated by gcc (standard function prologue */
		"st.a    r13, [sp, -4]   \n\t"
		"st.a    r14, [sp, -4]   \n\t"
		"st.a    r15, [sp, -4]   \n\t"
		"st.a    r16, [sp, -4]   \n\t"
		"st.a    r17, [sp, -4]   \n\t"
		"st.a    r18, [sp, -4]   \n\t"
		"st.a    r19, [sp, -4]   \n\t"
		"st.a    r20, [sp, -4]   \n\t"
		"st.a    r21, [sp, -4]   \n\t"
		"st.a    r22, [sp, -4]   \n\t"
		"st.a    r23, [sp, -4]   \n\t"
		"st.a    r24, [sp, -4]   \n\t"
#अगर_अघोषित CONFIG_ARC_CURR_IN_REG
		"st.a    r25, [sp, -4]   \n\t"
#अन्यथा
		"sub     sp, sp, 4      \n\t"	/* usual r25 placeholder */
#पूर्ण_अगर

		/* set ksp of outgoing task in tsk->thपढ़ो.ksp */
#अगर KSP_WORD_OFF <= 255
		"st.as   sp, [%3, %1]    \n\t"
#अन्यथा
		/*
		 * Workaround क्रम NR_CPUS=4k
		 * %1 is bigger than 255 (S9 offset क्रम st.as)
		 */
		"add2    r24, %3, %1     \n\t"
		"st      sp, [r24]       \n\t"
#पूर्ण_अगर

		/*
		 * setup _current_task with incoming tsk.
		 * optionally, set r25 to that as well
		 * For SMP extra work to get to &_current_task[cpu]
		 * (खोलो coded SET_CURR_TASK_ON_CPU)
		 */
#अगर_अघोषित CONFIG_SMP
		"st  %2, [@_current_task]	\n\t"
#अन्यथा
		"lr   r24, [identity]		\n\t"
		"lsr  r24, r24, 8		\n\t"
		"bmsk r24, r24, 7		\n\t"
		"add2 r24, @_current_task, r24	\n\t"
		"st   %2,  [r24]		\n\t"
#पूर्ण_अगर
#अगर_घोषित CONFIG_ARC_CURR_IN_REG
		"mov r25, %2   \n\t"
#पूर्ण_अगर

		/* get ksp of incoming task from tsk->thपढ़ो.ksp */
		"ld.as  sp, [%2, %1]   \n\t"

		/* start loading it's CALLEE reg file */

#अगर_अघोषित CONFIG_ARC_CURR_IN_REG
		"ld.ab   r25, [sp, 4]   \n\t"
#अन्यथा
		"add    sp, sp, 4       \n\t"
#पूर्ण_अगर
		"ld.ab   r24, [sp, 4]   \n\t"
		"ld.ab   r23, [sp, 4]   \n\t"
		"ld.ab   r22, [sp, 4]   \n\t"
		"ld.ab   r21, [sp, 4]   \n\t"
		"ld.ab   r20, [sp, 4]   \n\t"
		"ld.ab   r19, [sp, 4]   \n\t"
		"ld.ab   r18, [sp, 4]   \n\t"
		"ld.ab   r17, [sp, 4]   \n\t"
		"ld.ab   r16, [sp, 4]   \n\t"
		"ld.ab   r15, [sp, 4]   \n\t"
		"ld.ab   r14, [sp, 4]   \n\t"
		"ld.ab   r13, [sp, 4]   \n\t"

		/* last (ret value) = prev : although क्रम ARC it mov r0, r0 */
		"mov     %0, %3        \n\t"

		/* FP/BLINK restore generated by gcc (standard func epilogue */

		: "=r"(पंचांगp)
		: "n"(KSP_WORD_OFF), "r"(next), "r"(prev)
		: "blink"
	);

	वापस (काष्ठा task_काष्ठा *)पंचांगp;
पूर्ण
