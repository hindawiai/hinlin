<शैली गुरु>
// SPDX-License-Identअगरier: GPL-2.0-only
/*
 * Traps/Non-MMU Exception handling क्रम ARC
 *
 * Copyright (C) 2004, 2007-2010, 2011-2012 Synopsys, Inc. (www.synopsys.com)
 *
 * vineetg: May 2011
 *  -user-space unaligned access emulation
 *
 * Rahul Trivedi: Codito Technologies 2004
 */

#समावेश <linux/sched/संकेत.स>
#समावेश <linux/kdebug.h>
#समावेश <linux/uaccess.h>
#समावेश <linux/ptrace.h>
#समावेश <linux/kprobes.h>
#समावेश <linux/kgdb.h>
#समावेश <यंत्र/setup.h>
#समावेश <यंत्र/unaligned.h>
#समावेश <यंत्र/kprobes.h>

व्योम __init trap_init(व्योम)
अणु
	वापस;
पूर्ण

व्योम die(स्थिर अक्षर *str, काष्ठा pt_regs *regs, अचिन्हित दीर्घ address)
अणु
	show_kernel_fault_diag(str, regs, address);

	/* DEAD END */
	__यंत्र__("flag 1");
पूर्ण

/*
 * Helper called क्रम bulk of exceptions NOT needing specअगरic handling
 *  -क्रम user faults enqueues requested संकेत
 *  -क्रम kernel, chk अगर due to copy_(to|from)_user, otherwise die()
 */
अटल noअंतरभूत पूर्णांक
unhandled_exception(स्थिर अक्षर *str, काष्ठा pt_regs *regs,
		    पूर्णांक signo, पूर्णांक si_code, व्योम __user *addr)
अणु
	अगर (user_mode(regs)) अणु
		काष्ठा task_काष्ठा *tsk = current;

		tsk->thपढ़ो.fault_address = (__क्रमce अचिन्हित पूर्णांक)addr;

		क्रमce_sig_fault(signo, si_code, addr);

	पूर्ण अन्यथा अणु
		/* If not due to copy_(to|from)_user, we are करोomed */
		अगर (fixup_exception(regs))
			वापस 0;

		die(str, regs, (अचिन्हित दीर्घ)addr);
	पूर्ण

	वापस 1;
पूर्ण

#घोषणा DO_ERROR_INFO(signr, str, name, sicode) \
पूर्णांक name(अचिन्हित दीर्घ address, काष्ठा pt_regs *regs) \
अणु								\
	वापस unhandled_exception(str, regs, signr, sicode,	\
				   (व्योम __user *)address);	\
पूर्ण

/*
 * Entry poपूर्णांकs क्रम exceptions NOT needing specअगरic handling
 */
DO_ERROR_INFO(संक_अवैध, "Priv Op/Disabled Extn", करो_privilege_fault, ILL_PRVOPC)
DO_ERROR_INFO(संक_अवैध, "Invalid Extn Insn", करो_extension_fault, ILL_ILLOPC)
DO_ERROR_INFO(संक_अवैध, "Illegal Insn (or Seq)", insterror_is_error, ILL_ILLOPC)
DO_ERROR_INFO(SIGBUS, "Invalid Mem Access", __weak करो_memory_error, BUS_ADRERR)
DO_ERROR_INFO(SIGTRAP, "Breakpoint Set", trap_is_brkpt, TRAP_BRKPT)
DO_ERROR_INFO(SIGBUS, "Misaligned Access", करो_misaligned_error, BUS_ADRALN)
DO_ERROR_INFO(संक_अंश, "gcc generated __builtin_trap", करो_trap5_error, 0)

/*
 * Entry Poपूर्णांक क्रम Misaligned Data access Exception, क्रम emulating in software
 */
पूर्णांक करो_misaligned_access(अचिन्हित दीर्घ address, काष्ठा pt_regs *regs,
			 काष्ठा callee_regs *cregs)
अणु
	/* If emulation not enabled, or failed, समाप्त the task */
	अगर (misaligned_fixup(address, regs, cregs) != 0)
		वापस करो_misaligned_error(address, regs);

	वापस 0;
पूर्ण

/*
 * Entry poपूर्णांक क्रम miscll errors such as Nested Exceptions
 *  -Duplicate TLB entry is handled seperately though
 */
व्योम करो_machine_check_fault(अचिन्हित दीर्घ address, काष्ठा pt_regs *regs)
अणु
	die("Unhandled Machine Check Exception", regs, address);
पूर्ण


/*
 * Entry poपूर्णांक क्रम traps induced by ARCompact TRAP_S <n> insn
 * This is same family as TRAP0/SWI insn (use the same vector).
 * The only dअगरference being SWI insn take no opeअक्रम, जबतक TRAP_S करोes
 * which reflects in ECR Reg as 8 bit param.
 * Thus TRAP_S <n> can be used क्रम specअगरic purpose
 *  -1 used क्रम software अवरोधpoपूर्णांकing (gdb)
 *  -2 used by kprobes
 *  -5 __builtin_trap() generated by gcc (2018.03 onwards) क्रम toggle such as
 *     -fno-isolate-erroneous-paths-dereference
 */
व्योम करो_non_swi_trap(अचिन्हित दीर्घ address, काष्ठा pt_regs *regs)
अणु
	अचिन्हित पूर्णांक param = regs->ecr_param;

	चयन (param) अणु
	हाल 1:
		trap_is_brkpt(address, regs);
		अवरोध;

	हाल 2:
		trap_is_kprobe(address, regs);
		अवरोध;

	हाल 3:
	हाल 4:
		kgdb_trap(regs);
		अवरोध;

	हाल 5:
		करो_trap5_error(address, regs);
		अवरोध;
	शेष:
		अवरोध;
	पूर्ण
पूर्ण

/*
 * Entry poपूर्णांक क्रम Inकाष्ठाion Error Exception
 *  -For a corner हाल, ARC kprobes implementation resorts to using
 *   this exception, hence the check
 */
व्योम करो_insterror_or_kprobe(अचिन्हित दीर्घ address, काष्ठा pt_regs *regs)
अणु
	पूर्णांक rc;

	/* Check अगर this exception is caused by kprobes */
	rc = notअगरy_die(DIE_IERR, "kprobe_ierr", regs, address, 0, संक_अवैध);
	अगर (rc == NOTIFY_STOP)
		वापस;

	insterror_is_error(address, regs);
पूर्ण

/*
 * पात() call generated by older gcc क्रम __builtin_trap()
 */
व्योम पात(व्योम)
अणु
	__यंत्र__ __अस्थिर__("trap_s  5\n");
पूर्ण
