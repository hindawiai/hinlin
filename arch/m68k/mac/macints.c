<शैली गुरु>
// SPDX-License-Identअगरier: GPL-2.0
/*
 *	Macपूर्णांकosh पूर्णांकerrupts
 *
 * General design:
 * In contrary to the Amiga and Atari platक्रमms, the Mac hardware seems to
 * exclusively use the स्वतःvector पूर्णांकerrupts (the 'generic level0-level7'
 * पूर्णांकerrupts with exception vectors 0x19-0x1f). The following पूर्णांकerrupt levels
 * are used:
 *	1	- VIA1
 *		  - slot 0: one second पूर्णांकerrupt (CA2)
 *		  - slot 1: VBlank (CA1)
 *		  - slot 2: ADB data पढ़ोy (SR full)
 *		  - slot 3: ADB data  (CB2)
 *		  - slot 4: ADB घड़ी (CB1)
 *		  - slot 5: समयr 2
 *		  - slot 6: समयr 1
 *		  - slot 7: status of IRQ; संकेतs 'any enabled int.'
 *
 *	2	- VIA2 or RBV
 *		  - slot 0: SCSI DRQ (CA2)
 *		  - slot 1: NUBUS IRQ (CA1) need to पढ़ो port A to find which
 *		  - slot 2: /EXP IRQ (only on IIci)
 *		  - slot 3: SCSI IRQ (CB2)
 *		  - slot 4: ASC IRQ (CB1)
 *		  - slot 5: समयr 2 (not on IIci)
 *		  - slot 6: समयr 1 (not on IIci)
 *		  - slot 7: status of IRQ; संकेतs 'any enabled int.'
 *
 * Levels 3-6 vary by machine type. For VIA or RBV Macपूर्णांकoshes:
 *
 *	3	- unused (?)
 *
 *	4	- SCC
 *
 *	5	- unused (?)
 *		  [serial errors or special conditions seem to उठाओ level 6
 *		  पूर्णांकerrupts on some models (LC4xx?)]
 *
 *	6	- off चयन (?)
 *
 * Machines with Quadra-like VIA hardware, except PSC and PMU machines, support
 * an alternate पूर्णांकerrupt mapping, as used by A/UX. It spपढ़ोs ethernet and
 * sound out to their own स्वतःvector IRQs and gives VIA1 a higher priority:
 *
 *	1	- unused (?)
 *
 *	3	- on-board SONIC
 *
 *	5	- Apple Sound Chip (ASC)
 *
 *	6	- VIA1
 *
 * For OSS Macपूर्णांकoshes (IIfx only), we apply an पूर्णांकerrupt mapping similar to
 * the Quadra (A/UX) mapping:
 *
 *	1	- ISM IOP (ADB)
 *
 *	2	- SCSI
 *
 *	3	- NuBus
 *
 *	4	- SCC IOP
 *
 *	6	- VIA1
 *
 * For PSC Macपूर्णांकoshes (660AV, 840AV):
 *
 *	3	- PSC level 3
 *		  - slot 0: MACE
 *
 *	4	- PSC level 4
 *		  - slot 1: SCC channel A पूर्णांकerrupt
 *		  - slot 2: SCC channel B पूर्णांकerrupt
 *		  - slot 3: MACE DMA
 *
 *	5	- PSC level 5
 *
 *	6	- PSC level 6
 *
 * Finally we have good 'ole level 7, the non-maskable पूर्णांकerrupt:
 *
 *	7	- NMI (programmer's चयन on the back of some Macs)
 *		  Also RAM parity error on models which support it (IIc, IIfx?)
 *
 * The current पूर्णांकerrupt logic looks something like this:
 *
 * - We install dispatchers क्रम the स्वतःvector पूर्णांकerrupts (1-7). These
 *   dispatchers are responsible क्रम querying the hardware (the
 *   VIA/RBV/OSS/PSC chips) to determine the actual पूर्णांकerrupt source. Using
 *   this inक्रमmation a machspec पूर्णांकerrupt number is generated by placing the
 *   index of the पूर्णांकerrupt hardware पूर्णांकo the low three bits and the original
 *   स्वतःvector पूर्णांकerrupt number in the upper 5 bits. The handlers क्रम the
 *   resulting machspec पूर्णांकerrupt are then called.
 *
 * - Nubus is a special हाल because its पूर्णांकerrupts are hidden behind two
 *   layers of hardware. Nubus पूर्णांकerrupts come in as index 1 on VIA #2,
 *   which translates to IRQ number 17. In this spot we install _another_
 *   dispatcher. This dispatcher finds the पूर्णांकerrupting slot number (9-F) and
 *   then क्रमms a new machspec पूर्णांकerrupt number as above with the slot number
 *   minus 9 in the low three bits and the pseuकरो-level 7 in the upper five
 *   bits.  The handlers क्रम this new machspec पूर्णांकerrupt number are then
 *   called. This माला_दो Nubus पूर्णांकerrupts पूर्णांकo the range 56-62.
 *
 * - The Baboon पूर्णांकerrupts (used on some PowerBooks) are an even more special
 *   हाल. They're hidden behind the Nubus slot $C पूर्णांकerrupt thus adding a
 *   third layer of indirection. Why oh why did the Apple engineers करो that?
 *
 */

#समावेश <linux/types.h>
#समावेश <linux/kernel.h>
#समावेश <linux/sched.h>
#समावेश <linux/sched/debug.h>
#समावेश <linux/पूर्णांकerrupt.h>
#समावेश <linux/irq.h>
#समावेश <linux/delay.h>

#समावेश <यंत्र/irq.h>
#समावेश <यंत्र/macपूर्णांकosh.h>
#समावेश <यंत्र/macपूर्णांकs.h>
#समावेश <यंत्र/mac_via.h>
#समावेश <यंत्र/mac_psc.h>
#समावेश <यंत्र/mac_oss.h>
#समावेश <यंत्र/mac_iop.h>
#समावेश <यंत्र/mac_baboon.h>
#समावेश <यंत्र/hwtest.h>
#समावेश <यंत्र/irq_regs.h>

बाह्य व्योम show_रेजिस्टरs(काष्ठा pt_regs *);

irqवापस_t mac_nmi_handler(पूर्णांक, व्योम *);

अटल अचिन्हित पूर्णांक mac_irq_startup(काष्ठा irq_data *);
अटल व्योम mac_irq_shutकरोwn(काष्ठा irq_data *);

अटल काष्ठा irq_chip mac_irq_chip = अणु
	.name		= "mac",
	.irq_enable	= mac_irq_enable,
	.irq_disable	= mac_irq_disable,
	.irq_startup	= mac_irq_startup,
	.irq_shutकरोwn	= mac_irq_shutकरोwn,
पूर्ण;

व्योम __init mac_init_IRQ(व्योम)
अणु
	m68k_setup_irq_controller(&mac_irq_chip, handle_simple_irq, IRQ_USER,
				  NUM_MAC_SOURCES - IRQ_USER);

	/*
	 * Now रेजिस्टर the handlers क्रम the master IRQ handlers
	 * at levels 1-7. Most of the work is करोne अन्यथाwhere.
	 */

	अगर (oss_present)
		oss_रेजिस्टर_पूर्णांकerrupts();
	अन्यथा
		via_रेजिस्टर_पूर्णांकerrupts();
	अगर (psc)
		psc_रेजिस्टर_पूर्णांकerrupts();
	अगर (baboon_present)
		baboon_रेजिस्टर_पूर्णांकerrupts();
	iop_रेजिस्टर_पूर्णांकerrupts();
	अगर (request_irq(IRQ_AUTO_7, mac_nmi_handler, 0, "NMI",
			mac_nmi_handler))
		pr_err("Couldn't register NMI\n");
पूर्ण

/*
 *  mac_irq_enable - enable an पूर्णांकerrupt source
 * mac_irq_disable - disable an पूर्णांकerrupt source
 *
 * These routines are just dispatchers to the VIA/OSS/PSC routines.
 */

व्योम mac_irq_enable(काष्ठा irq_data *data)
अणु
	पूर्णांक irq = data->irq;
	पूर्णांक irq_src = IRQ_SRC(irq);

	चयन(irq_src) अणु
	हाल 1:
	हाल 2:
	हाल 7:
		अगर (oss_present)
			oss_irq_enable(irq);
		अन्यथा
			via_irq_enable(irq);
		अवरोध;
	हाल 3:
	हाल 4:
	हाल 5:
	हाल 6:
		अगर (psc)
			psc_irq_enable(irq);
		अन्यथा अगर (oss_present)
			oss_irq_enable(irq);
		अवरोध;
	हाल 8:
		अगर (baboon_present)
			baboon_irq_enable(irq);
		अवरोध;
	पूर्ण
पूर्ण

व्योम mac_irq_disable(काष्ठा irq_data *data)
अणु
	पूर्णांक irq = data->irq;
	पूर्णांक irq_src = IRQ_SRC(irq);

	चयन(irq_src) अणु
	हाल 1:
	हाल 2:
	हाल 7:
		अगर (oss_present)
			oss_irq_disable(irq);
		अन्यथा
			via_irq_disable(irq);
		अवरोध;
	हाल 3:
	हाल 4:
	हाल 5:
	हाल 6:
		अगर (psc)
			psc_irq_disable(irq);
		अन्यथा अगर (oss_present)
			oss_irq_disable(irq);
		अवरोध;
	हाल 8:
		अगर (baboon_present)
			baboon_irq_disable(irq);
		अवरोध;
	पूर्ण
पूर्ण

अटल अचिन्हित पूर्णांक mac_irq_startup(काष्ठा irq_data *data)
अणु
	पूर्णांक irq = data->irq;

	अगर (IRQ_SRC(irq) == 7 && !oss_present)
		via_nubus_irq_startup(irq);
	अन्यथा
		mac_irq_enable(data);

	वापस 0;
पूर्ण

अटल व्योम mac_irq_shutकरोwn(काष्ठा irq_data *data)
अणु
	पूर्णांक irq = data->irq;

	अगर (IRQ_SRC(irq) == 7 && !oss_present)
		via_nubus_irq_shutकरोwn(irq);
	अन्यथा
		mac_irq_disable(data);
पूर्ण

अटल अस्थिर पूर्णांक in_nmi;

irqवापस_t mac_nmi_handler(पूर्णांक irq, व्योम *dev_id)
अणु
	अगर (in_nmi)
		वापस IRQ_HANDLED;
	in_nmi = 1;

	pr_info("Non-Maskable Interrupt\n");
	show_रेजिस्टरs(get_irq_regs());

	in_nmi = 0;
	वापस IRQ_HANDLED;
पूर्ण
